<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PROJECT TRINITY</title>
<link rel="shortcut icon" content="favicon.webp" />

<style>
  :root{
    --fg:#e6e6e6; --fg-dim:#bdbdbd; --bg:#0a0a0a;
    --grad-1:#0a0a0a; --grad-2:#0d0d0d; --grad-3:#121212;
    --glass:#111111cc; --stroke:#262626; --accent:#8a8a8a;
    --chrome-h:96px; --radius:14px;
    --shadow:0 10px 26px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.03);
  }

  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; color:var(--fg);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans";
    background:
      radial-gradient(1100px 520px at 80% -10%, rgba(140,140,140,.10) 0%, rgba(140,140,140,0) 60%),
      radial-gradient(900px 480px at -10% 110%, rgba(160,160,160,.08) 0%, rgba(160,160,160,0) 60%),
      linear-gradient(180deg, var(--grad-1) 0%, var(--grad-2) 55%, var(--grad-3) 100%);
  }

  /* Collapse/Expand button */
  .chrome-toggle{
    position:fixed; top:10px; right:10px; z-index:10002;
    width:34px; height:34px; border-radius:10px;
    border:1px solid var(--stroke); color:var(--fg);
    background:linear-gradient(180deg, rgba(26,26,26,.95), rgba(18,18,18,.9));
    cursor:pointer; font-size:18px; line-height:1; padding:0;
    display:inline-flex; align-items:center; justify-content:center;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.03), 0 6px 18px rgba(0,0,0,.45);
  }
  .chrome-toggle:hover{
    border-color:var(--accent);
    background:linear-gradient(180deg, rgba(34,34,34,.96), rgba(22,22,22,.92));
    transform:translateY(-1px);
  }

  /* Header chrome */
  .chrome{
    position:fixed; inset:0 0 auto 0; z-index:10000;
    backdrop-filter:saturate(120%) blur(10px);
    background:linear-gradient(180deg, rgba(18,18,18,.82), rgba(12,12,12,.68));
    border-bottom:1px solid var(--stroke);
    box-shadow:var(--shadow);
  }
  html[data-collapsed="1"] .chrome{ display:none; }

  .row{ display:flex; align-items:center; gap:10px; padding:10px 12px; }
  .row.tabs{ border-bottom:1px solid var(--stroke); padding-bottom:8px; align-items:flex-end; }

  .tabs-wrap{
    flex:1 1 auto; display:flex; align-items:flex-end; gap:8px;
    overflow-x:auto; scrollbar-width:none; -ms-overflow-style:none; padding-left:6px;
  }
  .tabs-wrap::-webkit-scrollbar{ display:none }

  /* Tabs */
  .tab{
    position:relative; display:flex; align-items:center; gap:8px;
    max-width:240px; white-space:nowrap; user-select:none; cursor:pointer;
    padding:6px 12px;
    border:1px solid var(--stroke);
    border-bottom-color:transparent;
    border-radius:18px 18px 0 0;
    background:linear-gradient(180deg, rgba(28,28,28,.92), rgba(18,18,18,.88));
    color:var(--fg);
    box-shadow:0 6px 18px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.03);
    margin-bottom:-1px; z-index:1;
    transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
  }
  .tab:hover{ transform:translateY(-1px); box-shadow:0 10px 26px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04); }
  .tab.active{
    border-color:var(--accent);
    border-bottom-color:#0000;
    background:linear-gradient(180deg, rgba(32,32,32,.96), rgba(20,20,20,.92));
    box-shadow:0 14px 34px rgba(0,0,0,.6), 0 0 0 1px rgba(255,255,255,.04) inset;
    z-index:2;
  }
  .tab .label{ overflow:hidden; text-overflow:ellipsis; color:var(--fg) }

  .tab .close{
    display:inline-flex; align-items:center; justify-content:center;
    width:20px; height:20px; line-height:20px; border-radius:7px;
    border:1px solid transparent; color:var(--fg-dim);
  }
  .tab .close:hover{ border-color:var(--accent); color:#fff; background:rgba(255,255,255,.06) }

  .tab-add{
    flex:0 0 auto; width:28px; height:28px; border-radius:50%;
    border:1px solid var(--stroke); color:var(--fg);
    background:linear-gradient(180deg, rgba(26,26,26,.95), rgba(18,18,18,.9));
    cursor:pointer; font-size:16px;
    display:inline-flex; align-items:center; justify-content:center;
    margin-bottom:-1px; transition:background .12s ease, border-color .12s ease, transform .12s ease;
  }
  .tab-add:hover{ border-color:var(--accent); background:linear-gradient(180deg, rgba(34,34,34,.96), rgba(22,22,22,.92)); transform:translateY(-1px); }

  /* Omnibox row */
  .omnibox{ flex:1 1 auto; display:flex; align-items:center; gap:10px; padding:6px 12px; }

  .btn{
    border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(26,26,26,.95), rgba(18,18,18,.9));
    color:var(--fg); border-radius:10px; height:34px; min-width:34px; padding:0 10px;
    cursor:pointer; display:inline-flex; align-items:center; justify-content:center;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.03), 0 6px 18px rgba(0,0,0,.45);
    transition:transform .12s ease, border-color .12s ease, background .12s ease, box-shadow .12s ease;
  }
  .btn:hover{ border-color:var(--accent); background:linear-gradient(180deg, rgba(34,34,34,.96), rgba(22,22,22,.92)); transform:translateY(-1px); box-shadow:inset 0 1px 0 rgba(255,255,255,.04), 0 10px 26px rgba(0,0,0,.55); }
  .btn.toggled{ outline:2px solid rgba(255,255,255,.08) }

  .bar{
    flex:1 1 auto; display:flex; align-items:center; gap:8px;
    border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(24,24,24,.92), rgba(16,16,16,.9));
    border-radius:999px; padding:8px 14px; margin:0;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.03), 0 6px 18px rgba(0,0,0,.45);
  }
  .bar:focus-within{ outline:2px solid rgba(255,255,255,.08) }

  #sj-address{
    all:unset; color:var(--fg); width:100%;
    font:14px/1.3 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  }
  #sj-address::placeholder{ color:var(--fg-dim) }

  /* Home */
  .home{ max-width:980px; margin:calc(var(--chrome-h) + 28px) auto 18vh; padding:0 18px; }
  html[data-collapsed="1"] .home{ margin:28px auto 18vh; }
  .hero{
    padding:24px; border:1px solid var(--stroke); border-radius:var(--radius);
    background:linear-gradient(180deg, rgba(22,22,22,.78), rgba(14,14,14,.72));
    box-shadow:var(--shadow);
  }
  .title{ margin:0 0 10px; font-size:28px; font-weight:800; letter-spacing:.2px; }
  .subtitle{ margin:0; color:var(--fg-dim); font-size:13px }
  .links{ margin-top:14px; display:flex; gap:12px; align-items:center; font-size:12px; color:var(--fg-dim) }
  .links a{ color:var(--fg); text-decoration:none; border-bottom:1px dashed transparent; padding-bottom:1px }
  .links a:hover{ border-bottom-color:rgba(255,255,255,.12) }

  /* Hide error hooks visually */
  #sj-error,#sj-error-code{ display:none }

  /* Proxied surface */
  #sj-frame{
    position:fixed; left:0; right:0; top:var(--chrome-h);
    width:100vw; height:calc(100vh - var(--chrome-h));
    border:none; background:#0b0b0b; z-index:9999; display:none;
  }
  html[data-collapsed="1"] #sj-frame{ top:0; height:100vh; }

  /* Toast */
  .toast{
    position:fixed; top:10px; right:54px; z-index:10001;
    padding:10px 12px; border-radius:10px; border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(20,20,20,.96), rgba(14,14,14,.9));
    box-shadow:var(--shadow); color:var(--fg); font-size:12px;
  }

  @media (max-width:820px){
    :root{ --chrome-h:124px }
    .tab{ max-width:180px }
  }
</style>

<!-- Scramjet runtime & your app scripts -->
<script src="/scram/scramjet.all.js"></script>
<script src="/baremux/index.js" defer></script>
<script src="/epoxy/index.js" defer></script>
<script src="https://unpkg.com/wisp-js/dist/wisp.min.js" defer></script>
<script src="register-sw.js" defer></script>
<script src="search.js" defer></script>
<script src="index.js" defer></script>

<script>
  /* Default WISP over wss in prod */
  (function(){ if (!('WISP_URL' in window) && location.protocol==='https:') window.WISP_URL='wss://'+location.host+'/wisp/'; })();

  const LS_KEY = 'pt_chrome_collapsed';

  /* Measure header -> set --chrome-h */
  function measureChrome(){
    const collapsed = document.documentElement.dataset.collapsed === '1';
    const c=document.querySelector('.chrome');
    const h = collapsed || !c ? 0 : Math.ceil(c.getBoundingClientRect().height);
    document.documentElement.style.setProperty('--chrome-h', h+'px');
  }
  function setCollapsed(on){
    document.documentElement.dataset.collapsed = on ? '1' : '0';
    localStorage.setItem(LS_KEY, on ? '1' : '0');
    measureChrome();
    const t=document.getElementById('chrome-toggle');
    if (t){
      t.textContent = on ? '+' : '–';
      t.setAttribute('aria-label', on ? 'Expand header' : 'Collapse header');
      t.setAttribute('title', on ? 'Expand' : 'Collapse');
    }
  }
  addEventListener('resize',measureChrome);

  addEventListener('DOMContentLoaded',()=>{
    /* restore collapsed state */
    setCollapsed(localStorage.getItem(LS_KEY) === '1');

    /* DOM refs */
    const tabsWrap = document.getElementById('tabs');
    const addBtn   = document.getElementById('tab-add');
    const form     = document.getElementById('sj-form');
    const addr     = document.getElementById('sj-address');
    const frame    = document.getElementById('sj-frame');
    const home     = document.getElementById('home');
    const reloadBtn= document.getElementById('reload');
    const inspectBtn=document.getElementById('inspect');

    /* State */
    let tabs=[]; let active=-1; let nextId=1; let inspectorOn=false;

    function toast(msg){
      const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
      document.body.appendChild(t); setTimeout(()=>t.remove(), 2200);
    }

    /* Branding map for tab labels */
    const BRAND_MAP = {
      'tiktok.com':'TikTok','youtube.com':'YouTube','youtu.be':'YouTube',
      'instagram.com':'Instagram','x.com':'X','twitter.com':'Twitter',
      'facebook.com':'Facebook','reddit.com':'Reddit','wikipedia.org':'Wikipedia',
      'github.com':'GitHub','google.com':'Google','openai.com':'OpenAI'
    };
    function titleCaseHost(host){
      const parts = host.split('.'); const core = parts.slice(-2).join('.');
      if (BRAND_MAP[host]) return BRAND_MAP[host];
      if (BRAND_MAP[core]) return BRAND_MAP[core];
      const first = (parts[0]||'').replace(/^www$/i,'') || (parts[parts.length-2]||'');
      return first.replace(/[-_]+/g,' ').replace(/\b[a-z]/g, m => m.toUpperCase());
    }
    function prettyLabel(urlOrQuery){
      try { const u=new URL(urlOrQuery); return titleCaseHost(u.hostname); }
      catch {
        if ((urlOrQuery||'').startsWith('https://www.google.com/search?q=')) return 'Search';
        return (urlOrQuery && urlOrQuery.length>24) ? urlOrQuery.slice(0,24)+'…' : (urlOrQuery || 'New Tab');
      }
    }

    /* Normalize input into a URL */
    function normalizeInput(q){
      q=(q||'').trim();
      if(!/^[a-z][a-z0-9+.-]*:\/\//i.test(q) && !q.includes('.')) return 'https://www.google.com/search?q='+encodeURIComponent(q);
      if(!/^[a-z][a-z0-9+.-]*:\/\//i.test(q) &&  q.includes('.')) return 'https://'+q;
      return q.replace(/^http:\/\//i,'https://');
    }

    /* Extract the true target URL from a Scramjet iframe src */
    function extractTargetFromScramjet(src){
      try{
        const u = new URL(src, location.origin);
        const idx = u.pathname.indexOf('/scramjet/');
        if (idx === -1) return null;
        const after = u.pathname.slice(idx + '/scramjet/'.length);
        if (!after) return null;
        // First try whole remainder
        let decoded = decodeURIComponent(after);
        try { new URL(decoded); return decoded; } catch(_){}
        // Otherwise only up to first slash
        const firstSlash = after.indexOf('/');
        if (firstSlash > 0) {
          decoded = decodeURIComponent(after.slice(0, firstSlash));
          try { new URL(decoded); return decoded; } catch(_){}
        }
      }catch(_){}
      return null;
    }

    /* === Show the EXACT URL in the input, keep tab label pretty === */
    function setAddressBar(rawUrl){
      addr.value = rawUrl;                                     // exact URL in field
      if (active>=0) tabs[active].el.querySelector('.label').textContent = prettyLabel(rawUrl);
    }

    function updateHome(){
      const show = (!tabs.length || !tabs[active]?.url);
      home.style.display = show ? 'block' : 'none';
      if (show) { frame.removeAttribute('src'); frame.style.display='none'; }
    }

    function setActive(idx){
      if (idx===active || idx<0 || idx>=tabs.length) return;
      if (active>=0) tabs[active].el.classList.remove('active');
      active=idx; tabs[active].el.classList.add('active');

      const url=tabs[active].url||'';
      if (url) {
        setAddressBar(url);
        addr.dataset.raw = url;
        if (form.requestSubmit) form.requestSubmit();
        else form.dispatchEvent(new Event('submit', { bubbles:true, cancelable:true }));
      } else {
        addr.value=''; addr.placeholder='URL or search…';
        frame.removeAttribute('src'); frame.style.display='none';
      }
      updateHome();
      if (inspectorOn) enableInspector();
    }

    function addTab(initialUrl){
      const id=nextId++;
      const el=document.createElement('div');
      el.className='tab'; el.dataset.id=id;
      el.innerHTML=`<span class="label">New Tab</span><span class="close" title="Close" aria-label="Close">×</span>`;
      tabsWrap.insertBefore(el, addBtn);
      const tab={ id, el, url: initialUrl||'' };
      if (tab.url) el.querySelector('.label').textContent = prettyLabel(tab.url);
      tabs.push(tab);
      setActive(tabs.length-1);
    }

    function closeTabById(id){
      const idx=tabs.findIndex(t=>t.id===id);
      if (idx===-1) return;
      const wasActive=(idx===active);
      tabs[idx].el.remove();
      tabs.splice(idx,1);
      if (!tabs.length){ addTab(); return; }
      if (wasActive) setActive(Math.max(0,idx-1));
      else if (idx<active) active-=1;
      updateHome();
    }

    /* Tab click/close delegation */
    tabsWrap.addEventListener('click', (e) => {
      const closeEl = e.target.closest('.close');
      if (closeEl) {
        e.preventDefault(); e.stopPropagation();
        const tabEl = closeEl.closest('.tab');
        if (tabEl) closeTabById(Number(tabEl.dataset.id));
        return;
      }
      const tabEl = e.target.closest('.tab');
      if (tabEl) {
        e.preventDefault();
        const idx = tabs.findIndex(t=>t.id===Number(tabEl.dataset.id));
        setActive(idx);
      }
    });

    addBtn.addEventListener('click',()=>addTab());

    /* Reload behavior */
    reloadBtn.addEventListener('click',()=>{
      if (!tabs.length || active<0) return;
      const proxied = frame.getAttribute('src');
      if (proxied) {
        try { frame.contentWindow.location.reload(); }
        catch { frame.src = proxied; }
      } else {
        const raw = tabs[active].url || '';
        if (!raw) return;
        addr.dataset.raw = raw;
        setAddressBar(raw);
        if (form.requestSubmit) form.requestSubmit();
        else form.dispatchEvent(new Event('submit', { bubbles:true, cancelable:true }));
      }
    });

    /* Mini Inspector */
    function disableInspector(){
      try{
        const w = frame.contentWindow; const d = w.document;
        d.querySelector('#__mini_inspector_overlay__')?.remove();
        d.querySelector('#__mini_inspector_panel__')?.remove();
        d.removeEventListener('mousemove', w.__mini_inspector_move, true);
        d.removeEventListener('click', w.__mini_inspector_click, true);
        d.removeEventListener('keydown', w.__mini_inspector_key, true);
        w.__mini_inspector_move = w.__mini_inspector_click = w.__mini_inspector_key = null;
      }catch(_){}
      inspectorOn=false; inspectBtn.classList.remove('toggled');
    }
    function enableInspector(){
      try { void frame.contentDocument; }
      catch { toast("Can't inspect this page (cross-origin)."); disableInspector(); return; }
      const w = frame.contentWindow, d = w.document;
      if (d.getElementById('__mini_inspector_overlay__')) { inspectorOn=true; inspectBtn.classList.add('toggled'); return; }

      const overlay = d.createElement('div');
      overlay.id='__mini_inspector_overlay__';
      overlay.style.cssText='position:fixed;pointer-events:none;border:1px solid rgba(180,180,180,.9);outline:9999px solid rgba(0,0,0,.50);border-radius:8px;z-index:2147483646;left:0;top:0;width:0;height:0;box-shadow:0 0 0 1px rgba(255,255,255,.04) inset';

      const info = d.createElement('div');
      info.style.cssText='position:fixed;pointer-events:none;z-index:2147483647;background:rgba(22,22,22,.96);color:#e6e6e6;border:1px solid rgba(180,180,180,.6);border-radius:8px;padding:4px 8px;font:12px "Courier New",monospace;transform:translateY(-26px);box-shadow:0 8px 20px rgba(0,0,0,.55)';
      overlay.appendChild(info);

      const panel = d.createElement('div');
      panel.id='__mini_inspector_panel__';
      panel.style.cssText='position:fixed;right:12px;bottom:12px;z-index:2147483647;color:#e6e6e6;border:1px solid rgba(180,180,180,.45);border-radius:14px;padding:10px;max-width:48vw;min-width:300px;font:12px "Courier New",monospace;background:linear-gradient(180deg, rgba(24,24,24,.98), rgba(16,16,16,.94));box-shadow:0 16px 40px rgba(0,0,0,.65)';
      panel.innerHTML = `
        <div style="margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
          <strong>Inspector</strong>
          <button id="__mi_close__" style="background:transparent;color:#e6e6e6;border:1px solid rgba(180,180,180,.6);border-radius:8px;padding:4px 8px;cursor:pointer">Close</button>
        </div>
        <div style="margin-bottom:6px">Selected: <code id="__mi_sel__"></code></div>
        <label>textContent</label>
        <textarea id="__mi_text__" style="width:100%;height:70px;background:rgba(18,18,18,.96);color:#e6e6e6;border:1px solid rgba(180,180,180,.45);border-radius:10px;margin:4px 0 8px;resize:vertical;"></textarea>
        <label>outerHTML</label>
        <textarea id="__mi_html__" style="width:100%;height:150px;background:rgba(18,18,18,.96);color:#e6e6e6;border:1px solid rgba(180,180,180,.45);border-radius:10px;margin:4px 0 10px;resize:vertical;"></textarea>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="__mi_apply__"  style="background:transparent;color:#e6e6e6;border:1px solid rgba(180,180,180,.6);border-radius:10px;padding:6px 10px;cursor:pointer">Apply HTML</button>
          <button id="__mi_textbtn__"style="background:transparent;color:#e6e6e6;border:1px solid rgba(180,180,180,.6);border-radius:10px;padding:6px 10px;cursor:pointer">Apply Text</button>
          <button id="__mi_delete__" style="background:transparent;color:#ff8f8f;border:1px solid rgba(255,143,143,.6);border-radius:10px;padding:6px 10px;cursor:pointer">Delete Node</button>
        </div>
      `;
      d.body.appendChild(overlay); d.body.appendChild(panel);

      let current=null;
      function fmt(el){ if(!el) return ''; const tag=el.tagName.toLowerCase(); const id=el.id?`#${el.id}`:''; const cls=(el.className && typeof el.className==='string')?'.'+el.className.trim().split(/\s+/).join('.') : ''; return `${tag}${id}${cls}`; }

      w.__mini_inspector_move = function(ev){
        if (!ev.target || ev.target===overlay || ev.target===panel || panel.contains(ev.target)) return;
        const el=ev.target, r=el.getBoundingClientRect?.(); if(!r) return;
        overlay.style.left=r.left+'px'; overlay.style.top=r.top+'px'; overlay.style.width=r.width+'px'; overlay.style.height=r.height+'px';
        info.textContent = fmt(el) + `  ${Math.round(r.width)}×${Math.round(r.height)}`;
        info.style.left = Math.max(6, Math.min(r.left, d.documentElement.clientWidth - 220)) + 'px';
        info.style.top  = (r.top - 8) + 'px';
      };
      w.__mini_inspector_click = function(ev){
        if (panel.contains(ev.target)) return;
        ev.preventDefault(); ev.stopPropagation();
        current = ev.target;
        d.getElementById('__mi_sel__').textContent = fmt(current);
        d.getElementById('__mi_text__').value = current.textContent;
        try { d.getElementById('__mi_html__').value = current.outerHTML; } catch { d.getElementById('__mi_html__').value='<!-- cannot serialize -->'; }
      };
      w.__mini_inspector_key = function(ev){
        if (ev.key === 'Escape') { ev.preventDefault(); ev.stopPropagation(); parent.postMessage({__mini_inspector_cmd:'off'}, '*'); }
      };
      d.addEventListener('mousemove', w.__mini_inspector_move, true);
      d.addEventListener('click',     w.__mini_inspector_click, true);
      d.addEventListener('keydown',   w.__mini_inspector_key, true);
      panel.querySelector('#__mi_close__').onclick = ()=> parent.postMessage({__mini_inspector_cmd:'off'}, '*');

      panel.querySelector('#__mi_apply__').onclick = ()=>{
        if (!current) return;
        const html = d.getElementById('__mi_html__').value;
        try{
          const tmp = d.createElement('div'); tmp.innerHTML = html;
          const repl = tmp.firstElementChild; if (!repl) return;
          current.replaceWith(repl); current = repl;
          d.getElementById('__mi_sel__').textContent = fmt(current);
        }catch{ alert('Invalid HTML'); }
      };
      panel.querySelector('#__mi_textbtn__').onclick = ()=>{
        if (!current) return;
        current.textContent = d.getElementById('__mi_text__').value;
        d.getElementById('__mi_html__').value = current.outerHTML;
      };
      panel.querySelector('#__mi_delete__').onclick = ()=>{
        if (!current) return;
        const nxt = current.parentElement || d.body;
        current.remove(); current = nxt;
        d.getElementById('__mi_sel__').textContent = fmt(current);
        try { d.getElementById('__mi_html__').value = current.outerHTML || ''; } catch { d.getElementById('__mi_html__').value=''; }
        d.getElementById('__mi_text__').value = current.textContent || '';
      };

      w.addEventListener('message', (e)=>{ if (e.data && e.data.__mini_inspector_cmd==='off') {
        d.removeEventListener('mousemove', w.__mini_inspector_move, true);
        d.removeEventListener('click',     w.__mini_inspector_click, true);
        d.removeEventListener('keydown',   w.__mini_inspector_key, true);
        overlay.remove(); panel.remove();
      }});

      inspectorOn=true; inspectBtn.classList.add('toggled');
    }

    inspectBtn.addEventListener('click', ()=>{
      if (inspectorOn) { try { frame.contentWindow.postMessage({__mini_inspector_cmd:'off'}, '*'); } catch(_){}
        disableInspector();
      } else { enableInspector(); }
    });

    /* Submit: navigate & show EXACT URL immediately */
    form.addEventListener('submit',()=>{
      const n = normalizeInput(addr.value);
      if (active>=0) { tabs[active].url = n; addr.dataset.raw = n; }
      setAddressBar(n);           // exact URL in the field
      frame.style.display = 'block';
      home.style.display  = 'none';
      setTimeout(()=>{ if (inspectorOn) enableInspector(); }, 400);
    }, true);

    /* Keep omnibox synced with iframe navigation */
    let lastTarget = null;
    function syncFromFrame(){
      const src = frame.getAttribute('src') || '';
      const target = extractTargetFromScramjet(src) || (addr.dataset.raw || null);
      if (target && target !== lastTarget){
        lastTarget = target;
        if (active>=0) tabs[active].url = target;
        setAddressBar(target);    // exact URL
      }
    }
    frame.addEventListener('load', syncFromFrame);
    setInterval(syncFromFrame, 1200);

    /* Init app */
    function updateHome(){ const show = (!tabs.length || !tabs[active]?.url); home.style.display = show ? 'block' : 'none'; if (show) { frame.removeAttribute('src'); frame.style.display='none'; } }
    function addTab(initialUrl){
      const id=nextId++; const el=document.createElement('div');
      el.className='tab'; el.dataset.id=id;
      el.innerHTML=`<span class="label">New Tab</span><span class="close" title="Close" aria-label="Close">×</span>`;
      tabsWrap.insertBefore(el, addBtn);
      const tab={ id, el, url: initialUrl||'' };
      if (tab.url) el.querySelector('.label').textContent = prettyLabel(tab.url);
      tabs.push(tab); setActive(tabs.length-1);
    }

    addTab(); updateHome(); measureChrome();

    /* Collapse toggle button */
    document.getElementById('chrome-toggle').addEventListener('click', ()=>{
      const now = !(document.documentElement.dataset.collapsed === '1');
      setCollapsed(now);
    });

    /* Close tab delegation already attached above */
  });
</script>
</head>

<body>
  <!-- Collapse/Expand -->
  <button id="chrome-toggle" class="chrome-toggle" title="Collapse" aria-label="Collapse">–</button>

  <!-- Fixed header -->
  <div class="chrome" role="navigation" aria-label="Browser controls">
    <!-- Tabs row -->
    <div class="row tabs">
      <div class="tabs-wrap" id="tabs" role="tablist" aria-label="Tabs">
        <button id="tab-add" class="tab-add" title="New tab">+</button>
      </div>
    </div>
    <!-- Omnibox row -->
    <div class="row">
      <div class="omnibox">
        <button id="reload"  class="btn" title="Reload">↻</button>
        <button id="inspect" class="btn" title="Inspect (toggle)">&lt;/&gt;</button>
        <form id="sj-form" class="bar" autocomplete="off" role="search">
          <input id="sj-search-engine" type="hidden" value="https://www.google.com/search?q=%s" />
          <input id="sj-address" type="text" placeholder="URL or search…" spellcheck="false" inputmode="url" />
        </form>
      </div>
    </div>
  </div>

  <!-- Home -->
  <main class="home" id="home">
    <div class="hero">
      <h1 class="title">PROJECT TRINITY</h1>
      <p class="subtitle">1.1.4</p>
      <div class="links">
        <a href="credits.html">Credits</a><span>·</span>
        <a href="https://github.com/MercuryWorkshop" target="_blank" rel="noopener">Github</a><span>·</span>
        <a href="https://www.trinity.gt.tc" target="_blank" rel="noopener">TRINITY</a><span>·</span>
        <span>PT © 2025</span>
      </div>
    </div>
  </main>

  <!-- Proxied surface -->
  <iframe id="sj-frame"></iframe>

  <!-- Kept hooks -->
  <p id="sj-error"></p>
  <pre id="sj-error-code"></pre>
</body>
</html>
