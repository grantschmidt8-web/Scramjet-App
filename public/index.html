<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PROJECT TRINITY</title>
<link rel="shortcut icon" content="favicon.webp" />

<style>
  :root{
    --fg:#e6e6e6; --fg-dim:#bdbdbd; --bg:#0a0a0a;
    --grad-1:#0a0a0a; --grad-2:#0d0d0d; --grad-3:#121212;
    --stroke:#262626; --accent:#8a8a8a; --chrome-h:96px; --radius:14px;
    --shadow:0 10px 26px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.03);
  }
  *{ box-sizing:border-box } html,body{ height:100% }
  body{
    margin:0; color:var(--fg);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans";
    background:
      radial-gradient(1100px 520px at 80% -10%, rgba(140,140,140,.10) 0%, rgba(140,140,140,0) 60%),
      radial-gradient(900px 480px at -10% 110%, rgba(160,160,160,.08) 0%, rgba(160,160,160,0) 60%),
      linear-gradient(180deg, var(--grad-1) 0%, var(--grad-2) 55%, var(--grad-3) 100%);
  }

  .chrome{ position:fixed; inset:0 0 auto 0; z-index:10000; backdrop-filter:saturate(120%) blur(10px);
    background:linear-gradient(180deg, rgba(18,18,18,.82), rgba(12,12,12,.68)); border-bottom:1px solid var(--stroke); box-shadow:var(--shadow); }
  html[data-collapsed="1"] .chrome{ display:none; }

  .row{ display:flex; align-items:center; gap:10px; padding:10px 12px; }
  .row.tabs{ border-bottom:1px solid var(--stroke); padding-bottom:8px; align-items:flex-end; overflow:visible; }

  .tabs-wrap{ flex:1 1 auto; display:flex; align-items:flex-end; gap:8px; overflow-x:auto; padding-left:6px; scrollbar-width:none; }
  .tabs-wrap::-webkit-scrollbar{ display:none }

  .tab{
    position:relative; display:flex; align-items:center; gap:8px; max-width:260px; white-space:nowrap; cursor:pointer;
    padding:6px 12px; border:1px solid var(--stroke); border-bottom-color:transparent; border-radius:18px 18px 0 0;
    background:linear-gradient(180deg, rgba(28,28,28,.92), rgba(18,18,18,.88)); color:var(--fg);
    box-shadow:0 6px 18px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.03); margin-bottom:-1px; z-index:1;
    transition:box-shadow .12s ease, border-color .12s ease, background .12s ease;
  }
  .tab:hover{ box-shadow:0 10px 26px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04); }
  .tab.active{ border-color:var(--accent); border-bottom-color:#0000;
    background:linear-gradient(180deg, rgba(32,32,32,.96), rgba(20,20,20,.92));
    box-shadow:0 14px 34px rgba(0,0,0,.6), 0 0 0 1px rgba(255,255,255,.04) inset; z-index:2; }
  .tab .fav{ width:16px; height:16px; border-radius:4px; object-fit:cover; flex:0 0 16px; background:#1a1a1a; border:1px solid #2a2a2a; }
  .tab .label{ overflow:hidden; text-overflow:ellipsis; color:var(--fg) }
  .tab .close{ display:inline-flex; align-items:center; justify-content:center; width:20px; height:20px; border-radius:7px; color:var(--fg-dim); }
  .tab-add{ flex:0 0 auto; width:28px; height:28px; border-radius:50%; border:1px solid var(--stroke);
    color:var(--fg); background:linear-gradient(180deg, rgba(26,26,26,.95), rgba(18,18,18,.9)); cursor:pointer; font-size:16px;
    display:inline-flex; align-items:center; justify-content:center; margin-bottom:-1px; }

  .omnibox{ flex:1 1 auto; display:flex; align-items:center; gap:10px; padding:6px 12px; min-width:0; }
  .btn{
    border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(26,26,26,.95), rgba(18,18,18,.9));
    color:var(--fg); border-radius:10px; height:34px; min-width:34px; padding:0 10px;
    cursor:pointer; display:inline-flex; align-items:center; justify-content:center;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.03), 0 6px 18px rgba(0,0,0,.45);
  }
  .btn.icon{ width:34px; min-width:34px; padding:0; font-size:16px; }

  /* Floating expand button for collapsed state */
  .fab{
    position:fixed; top:10px; right:12px; z-index:10005;
    border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(26,26,26,.95), rgba(18,18,18,.9));
    color:var(--fg); border-radius:10px; width:34px; height:34px;
    display:inline-flex; align-items:center; justify-content:center;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.03), 0 6px 18px rgba(0,0,0,.45);
  }
  html:not([data-collapsed="1"]) #chrome-fab{ display:none; }
  html[data-collapsed="1"] #chrome-fab{ display:inline-flex; }

  #site-favicon{ width:18px; height:18px; border-radius:4px; object-fit:cover; background:#1a1a1a; border:1px solid #2a2a2a; }

  .bar{
    flex:1 1 420px; max-width:100%; min-width:160px;
    display:flex; align-items:center; gap:8px;
    border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(24,24,24,.92), rgba(16,16,16,.9));
    border-radius:999px; padding:8px 14px; margin:0;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.03), 0 6px 18px rgba(0,0,0,.45);
  }
  #sj-address{ all:unset; color:var(--fg); width:100%; font:14px/1.3 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; }
  #sj-address::placeholder{ color:var(--fg-dim) }

  .home{ max-width:980px; margin:calc(var(--chrome-h) + 28px) auto 18vh; padding:0 18px; }
  html[data-collapsed="1"] .home{ margin:28px auto 18vh; }
  .hero{ padding:24px; border:1px solid var(--stroke); border-radius:var(--radius);
    background:linear-gradient(180deg, rgba(22,22,22,.78), rgba(14,14,14,.72)); box-shadow:var(--shadow); }
  .title{ margin:0 0 10px; font-size:28px; font-weight:800; letter-spacing:.2px; }
  .subtitle{ margin:0; color:var(--fg-dim); font-size:13px }
  .links{ margin-top:14px; display:flex; gap:12px; align-items:center; font-size:12px; color:var(--fg-dim) }
  .links a{ color:var(--fg); text-decoration:none; border-bottom:1px dashed transparent; padding-bottom:1px }

  #sj-error,#sj-error-code{ display:none }

  #sj-frame{
    position:fixed; left:0; right:0; top:var(--chrome-h);
    width:100vw; height:calc(100vh - var(--chrome-h));
    border:none; background:#0b0b0b;
    z-index:9998; display:none;
  }
  html[data-collapsed="1"] #sj-frame{ top:0; height:100vh; }

  /* Settings Popover */
  .settings-pop{
    position:fixed; z-index:10004; display:none;
    border:1px solid var(--stroke); border-radius:12px; padding:12px;
    background:linear-gradient(180deg, rgba(24,24,24,.98), rgba(16,16,16,.94));
    box-shadow:var(--shadow); color:var(--fg); width: min(420px, calc(100vw - 20px));
  }
  .settings-pop h4{ margin:0 0 8px; font-size:14px; }
  .settings-group{ margin-bottom:10px; }
  .settings-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .chip{
    border:1px solid var(--stroke); border-radius:10px; padding:6px 10px; cursor:pointer;
    background:linear-gradient(180deg, rgba(26,26,26,.95), rgba(18,18,18,.9)); color:var(--fg);
  }
  .chip[data-active="1"]{ outline:2px solid rgba(255,255,255,.10) }

  /* UPDATED: stronger bordered swatches (2px) + hover/active */
  .swatch{
    width:84px; height:40px; border-radius:10px; border:2px solid var(--stroke);
    cursor:pointer; position:relative;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.03);
    transition:border-color .12s ease, box-shadow .12s ease, transform .12s ease;
  }
  .swatch:hover{
    border-color: var(--accent);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.05), 0 6px 18px rgba(0,0,0,.35);
    transform: translateY(-1px);
  }
  .swatch[data-active="1"]{
    border-color: var(--accent);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.06), 0 10px 26px rgba(0,0,0,.45);
  }
  .swatch[data-active="1"]::after{
    content:"✓"; position:absolute; right:8px; bottom:6px; font-size:14px; color:currentColor; opacity:.9;
  }

  /* Inherit theme text color in settings */
  .settings-pop, .settings-pop * { color: inherit; }

  /* Show swatches for current theme only */
  :root[data-theme="dark"]  .swatch[data-theme="light"]{ display:none; }
  :root[data-theme="light"] .swatch[data-theme="dark"] { display:none; }

  @media (max-width:820px){
    :root{ --chrome-h:124px }
    .tab{ max-width:180px }
    .bar{ flex-basis: 320px; }
  }
</style>

<!-- Runtime/transport -->
<script src="/scram/scramjet.all.js"></script>
<script src="/baremux/index.js" defer></script>
<script src="/epoxy/index.js" defer></script>
<script src="https://unpkg.com/wisp-js/dist/wisp.min.js" defer></script>
<script src="register-sw.js" defer></script>
<script src="search.js" defer></script>
<script src="index.js" defer></script>

<script>
  (function(){ if (!('WISP_URL' in window) && location.protocol==='https:') window.WISP_URL='wss://'+location.host+'/wisp/'; })();

  const LS_KEY_COLLAPSE   = 'pt_chrome_collapsed';
  const LS_KEY_THEME      = 'pt_theme';
  const LS_KEY_GRAD_DARK  = 'pt_gradient_dark';
  const LS_KEY_GRAD_LIGHT = 'pt_gradient_light';

  const DARK_FAV = 'data:image/svg+xml;utf8,' + encodeURIComponent(
    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">' +
      '<rect width="24" height="24" rx="4" fill="#222222"/>' +
      '<path d="M6 12h12M12 6v12" stroke="#6e6e6e" stroke-width="1.5" stroke-linecap="round"/>' +
    '</svg>'
  );

  const THEMES = {
    dark: { fg:'#e6e6e6', dim:'#bdbdbd', bg:'#0a0a0a', stroke:'#262626', accent:'#8a8a8a',
      chromeBg:'linear-gradient(180deg, rgba(18,18,18,.82), rgba(12,12,12,.68))',
      cardBg:'linear-gradient(180deg, rgba(22,22,22,.78), rgba(14,14,14,.72))',
      barBg:'linear-gradient(180deg, rgba(24,24,24,.92), rgba(16,16,16,.9))',
      btnBg:'linear-gradient(180deg, rgba(26,26,26,.95), rgba(18,18,18,.9))',
      tabBg:'linear-gradient(180deg, rgba(28,28,28,.92), rgba(18,18,18,.88))',
      tabBgAct:'linear-gradient(180deg, rgba(32,32,32,.96), rgba(20,20,20,.92))',
      iframeBg:'#0b0b0b',
      rad1:'rgba(140,140,140,.10)', rad2:'rgba(160,160,160,.08)'
    },
    light: { fg:'#111', dim:'#444', bg:'#f5f6f8', stroke:'#d5d7db', accent:'#8a8a8a',
      chromeBg:'linear-gradient(180deg, rgba(255,255,255,.82), rgba(248,248,248,.88))',
      cardBg:'linear-gradient(180deg, rgba(255,255,255,.92), rgba(246,246,246,.90))',
      barBg:'linear-gradient(180deg, rgba(255,255,255,.96), rgba(246,246,246,.94))',
      btnBg:'linear-gradient(180deg, rgba(255,255,255,.96), rgba(244,244,244,.94))',
      tabBg:'linear-gradient(180deg, rgba(255,255,255,.95), rgba(245,245,245,.92))',
      tabBgAct:'linear-gradient(180deg, rgba(255,255,255,.98), rgba(238,238,238,.96))',
      iframeBg:'#ffffff',
      rad1:'rgba(0,0,0,.06)', rad2:'rgba(0,0,0,.04)'
    }
  };

  /* 6 gradients per theme */
  const GRADS = {
    // dark-side (6)
    graphite:{ theme:'dark', sw:['#0a0a0a','#0d0d0d','#121212'] },
    abyss:   { theme:'dark', sw:['#0a0f1a','#0b1320','#0c1726'] },
    violet:  { theme:'dark', sw:['#120a1a','#1a0f2b','#23143a'] },
    teal:    { theme:'dark', sw:['#071a1a','#0a2222','#0d2a2a'] },
    slate:   { theme:'dark', sw:['#0c0d10','#101218','#141820'] },
    obsidian:{ theme:'dark', sw:['#0b0c0e','#101318','#171b22'] },

    // light-side (6)
    paper:   { theme:'light', sw:['#f6f7f9','#eef0f4','#e7eaf0'] },
    linen:   { theme:'light', sw:['#faf7f2','#f2eadf','#e7dcc9'] },
    dawn:    { theme:'light', sw:['#fdf3f0','#f9e7e2','#f0d9d2'] },
    sky:     { theme:'light', sw:['#f3f8ff','#e7f1ff','#dceaff'] },
    mint:    { theme:'light', sw:['#f2fbf6','#e5f6ee','#d7efe5'] },
    pearl:   { theme:'light', sw:['#ffffff','#f6f7fb','#eceff6'] }
  };

  function buildBodyBackground(themeName){
    const t = THEMES[themeName] || THEMES.dark;
    const g1 = getComputedStyle(document.documentElement).getPropertyValue('--grad-1').trim() || '#0a0a0a';
    const g2 = getComputedStyle(document.documentElement).getPropertyValue('--grad-2').trim() || '#0d0d0d';
    const g3 = getComputedStyle(document.documentElement).getPropertyValue('--grad-3').trim() || '#121212';
    return [
      `radial-gradient(1100px 520px at 80% -10%, ${t.rad1} 0%, rgba(0,0,0,0) 60%)`,
      `radial-gradient(900px 480px at -10% 110%, ${t.rad2} 0%, rgba(0,0,0,0) 60%)`,
      `linear-gradient(180deg, ${g1} 0%, ${g2} 55%, ${g3} 100%)`
    ].join(', ');
  }

  function repaintTabsForTheme(){
    const theme = localStorage.getItem(LS_KEY_THEME) || 'dark';
    const t = THEMES[theme] || THEMES.dark;
    document.querySelectorAll('.tab').forEach(n=>{
      n.style.setProperty('background', n.classList.contains('active') ? t.tabBgAct : t.tabBg);
    });
  }

  function repaintSettings(themeName){
    const t = THEMES[themeName] || THEMES.dark;
    const pop = document.getElementById('settings-pop');
    if (!pop) return;
    pop.style.background  = t.cardBg;
    pop.style.borderColor = t.stroke;
    pop.style.color       = t.fg;
    pop.querySelectorAll('.chip').forEach(el=>{
      el.style.background  = t.btnBg;
      el.style.borderColor = t.stroke;
      el.style.color       = t.fg;
    });
    pop.querySelectorAll('.swatch').forEach(el=>{
      el.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--stroke').trim() || '#262626';
    });
  }

  function gradientBelongsToTheme(gradName, theme){ const g = GRADS[gradName]; return !!g && g.theme === theme; }
  function defaultGradFor(theme){ return theme === 'light' ? 'paper' : 'graphite'; }
  function setGradientVars(name){
    const g = GRADS[name] || GRADS[defaultGradFor('dark')];
    document.documentElement.style.setProperty('--grad-1', g.sw[0]);
    document.documentElement.style.setProperty('--grad-2', g.sw[1]);
    document.documentElement.style.setProperty('--grad-3', g.sw[2]);
  }

  function applyGradient(name){
    const theme = localStorage.getItem(LS_KEY_THEME) || 'dark';
    const g = GRADS[name]; if (!g || g.theme !== theme) return;
    setGradientVars(name);
    localStorage.setItem(theme === 'light' ? LS_KEY_GRAD_LIGHT : LS_KEY_GRAD_DARK, name);
    applyTheme(theme);
  }

  function applyTheme(name){
    const t = THEMES[name] || THEMES.dark;
    document.documentElement.dataset.theme = name;

    const stored = (name === 'light'
      ? localStorage.getItem(LS_KEY_GRAD_LIGHT)
      : localStorage.getItem(LS_KEY_GRAD_DARK)) || defaultGradFor(name);
    const useGrad = gradientBelongsToTheme(stored, name) ? stored : defaultGradFor(name);
    setGradientVars(useGrad);

    const root = document.documentElement.style;
    root.setProperty('--fg', t.fg);
    root.setProperty('--fg-dim', t.dim);
    root.setProperty('--bg', t.bg);
    root.setProperty('--stroke', t.stroke);
    root.setProperty('--accent', t.accent);

    document.body.style.color = t.fg;
    document.body.style.background = buildBodyBackground(name);
    document.querySelector('.chrome')?.style.setProperty('background', t.chromeBg);
    document.querySelectorAll('.hero').forEach(n=>n.style.setProperty('background', t.cardBg));
    document.querySelectorAll('.bar').forEach(n=>n.style.setProperty('background', t.barBg));
    document.querySelectorAll('.btn').forEach(n=>n.style.setProperty('background', t.btnBg));
    document.getElementById('sj-frame')?.style.setProperty('background', t.iframeBg);

    repaintSettings(name);
    localStorage.setItem(LS_KEY_THEME, name);
    repaintTabsForTheme();
  }

  function applyGradientToUIActiveState(){
    const theme = document.documentElement.dataset.theme || 'dark';
    const current = (theme==='light'
      ? localStorage.getItem(LS_KEY_GRAD_LIGHT)
      : localStorage.getItem(LS_KEY_GRAD_DARK)) || defaultGradFor(theme);
    document.querySelectorAll('.swatch').forEach(el=>{
      el.dataset.active = (el.dataset.value === current ? '1' : '0');
    });
  }

  function measureChrome(){
    const collapsed = document.documentElement.dataset.collapsed === '1';
    const c=document.querySelector('.chrome');
    const h = collapsed || !c ? 0 : Math.ceil(c.getBoundingClientRect().height);
    document.documentElement.style.setProperty('--chrome-h', h+'px');
  }

  function setCollapsed(on){
    document.documentElement.dataset.collapsed = on ? '1' : '0';
    localStorage.setItem(LS_KEY_COLLAPSE, on ? '1' : '0');
    measureChrome();

    const t=document.getElementById('chrome-toggle');
    if (t){
      t.textContent = on ? '+' : '–';
      t.setAttribute('aria-label', on ? 'Expand header' : 'Collapse header');
      t.setAttribute('title', on ? 'Expand' : 'Collapse');
    }
    const fab = document.getElementById('chrome-fab');
    if (fab){
      fab.textContent = on ? '+' : '–';
      fab.setAttribute('aria-label', on ? 'Expand header' : 'Collapse header');
      fab.setAttribute('title', on ? 'Expand' : 'Collapse');
    }
  }

  function prox(u){ try{ return location.origin + '/scramjet/' + encodeURIComponent(u); }catch{ return u; } }
  function extractTargetFromScramjet(proxiedHref){
    try{
      const u = new URL(proxiedHref, location.origin);
      const parts = u.pathname.split('/scramjet/');
      if (parts.length < 2) return null;
      const remainder = parts[1];
      const cut = remainder.indexOf('/');
      const encodedOrigin = cut === -1 ? remainder : remainder.slice(0, cut);
      const restPath = cut === -1 ? '' : remainder.slice(cut);
      const base = decodeURIComponent(encodedOrigin);
      let finalUrl; try { finalUrl = new URL(restPath || '/', base).href; } catch { finalUrl = base; }
      if (u.hash && !finalUrl.includes('#')) { try { const tmp=new URL(finalUrl); tmp.hash=u.hash; finalUrl=tmp.href; } catch {} }
      return finalUrl.replace(/(?<=https?:\/\/[^/]+)\/{2,}/, '/');
    }catch(_){ return null; }
  }

  addEventListener('resize',measureChrome);

  addEventListener('DOMContentLoaded',()=>{
    const theme = localStorage.getItem(LS_KEY_THEME) || 'dark';
    if (!localStorage.getItem(LS_KEY_GRAD_DARK))  localStorage.setItem(LS_KEY_GRAD_DARK,  'graphite');
    if (!localStorage.getItem(LS_KEY_GRAD_LIGHT)) localStorage.setItem(LS_KEY_GRAD_LIGHT, 'paper');

    applyTheme(theme);
    setCollapsed(localStorage.getItem(LS_KEY_COLLAPSE) === '1');

    const tabsWrap = document.getElementById('tabs');
    const addBtn   = document.getElementById('tab-add');
    const form     = document.getElementById('sj-form');
    const addr     = document.getElementById('sj-address');
    const frame    = document.getElementById('sj-frame');
    const home     = document.getElementById('home');
    const reloadBtn= document.getElementById('reload');
    const inspectBtn=document.getElementById('inspect');
    const headerFav = document.getElementById('site-favicon');
    const settingsBtn = document.getElementById('settings');
    const chromeToggle = document.getElementById('chrome-toggle');
    const settingsPop = document.getElementById('settings-pop');
    const chromeFab = document.getElementById('chrome-fab');

    if (headerFav) headerFav.src = DARK_FAV;

    let tabs=[]; let active=-1; let nextId=1; let inspectorOn=false;
    let userEditing=false;

    addr.addEventListener('focus', ()=>{ userEditing = true; });
    addr.addEventListener('input', ()=>{ userEditing = true; });
    addr.addEventListener('blur',  ()=>{ userEditing = false; });

    function prettyLabel(urlOrQuery){
      try { const u=new URL(urlOrQuery); const h=u.hostname.replace(/^www\./,''); return h.split('.')[0].replace(/[-_]+/g,' ').replace(/\b[a-z]/g,m=>m.toUpperCase()); }
      catch { return (urlOrQuery||'').slice(0,24) || 'New Tab'; }
    }
    function normalizeInput(q){
      q=(q||'').trim();
      if(!/^[a-z][a-z0-9+.-]*:\/\//i.test(q) && !q.includes('.')) return 'https://www.google.com/search?q='+encodeURIComponent(q);
      if(!/^[a-z][a-z0-9+.-]*:\/\//i.test(q) &&  q.includes('.')) return 'https://'+q;
      return q.replace(/^http:\/\//i,'https://');
    }

    function setAddressBar(rawUrl, opts={force:false}){
      if (!opts.force && userEditing) return;
      addr.value = rawUrl;
      if (active>=0) tabs[active].el.querySelector('.label').textContent = prettyLabel(rawUrl);
    }
    function clearAddressBar(){ addr.value=''; addr.placeholder='URL or search…'; delete addr.dataset.raw; }
    function focusAddr(){ setTimeout(()=>{ addr.focus(); try{ const L=addr.value.length; addr.setSelectionRange(L,L);}catch{} },0); }

    function updateHome(){
      const show = (!tabs.length || !tabs[active]?.url);
      home.style.display = show ? 'block' : 'none';
      if (show) { frame.removeAttribute('src'); frame.style.display='none'; }
    }

    function setActive(idx){
      if (idx===active || idx<0 || idx>=tabs.length) return;
      if (active>=0) tabs[active].el.classList.remove('active');
      active=idx; tabs[active].el.classList.add('active');
      repaintTabsForTheme();

      const url=tabs[active].url||'';
      if (url) {
        addr.dataset.raw = url; setAddressBar(url, {force:true});
        if (form.requestSubmit) form.requestSubmit();
        else form.dispatchEvent(new Event('submit', { bubbles:true, cancelable:true }));
      } else {
        clearAddressBar(); frame.removeAttribute('src'); frame.style.display='none'; home.style.display='block'; focusAddr();
      }
      updateHome();
    }

    function addTab(initialUrl){
      const id=nextId++;
      const el=document.createElement('div');
      el.className='tab'; el.dataset.id=id;
      el.innerHTML=`<img class="fav" alt="" src="${DARK_FAV}" referrerpolicy="no-referrer" crossorigin="anonymous"/>
                    <span class="label">New Tab</span>
                    <span class="close" title="Close" aria-label="Close">×</span>`;
      tabsWrap.insertBefore(el, addBtn);
      const tab={ id, el, url: (initialUrl || '') };
      if (tab.url) el.querySelector('.label').textContent = prettyLabel(tab.url);
      tabs.push(tab);
      setActive(tabs.length-1);
      measureChrome();
    }
    function closeTabById(id){
      const idx=tabs.findIndex(t=>t.id===id); if (idx===-1) return;
      const wasActive=(idx===active); tabs[idx].el.remove(); tabs.splice(idx,1);
      if (!tabs.length){ addTab(); return; }
      if (wasActive) setActive(Math.max(0,idx-1)); else if (idx<active) active-=1;
      updateHome();
    }
    tabsWrap.addEventListener('click', (e) => {
      const closeEl = e.target.closest('.close');
      if (closeEl) { e.preventDefault(); e.stopPropagation(); const tabEl = closeEl.closest('.tab'); if (tabEl) closeTabById(Number(tabEl.dataset.id)); return; }
      const tabEl = e.target.closest('.tab'); if (tabEl) { e.preventDefault(); const idx = tabs.findIndex(t=>t.id===Number(tabEl.dataset.id)); setActive(idx); }
    });

    addBtn.addEventListener('click',()=>{ setCollapsed(false); addTab(); focusAddr(); });
    reloadBtn.addEventListener('click',()=>{
      if (!tabs.length || active<0) return;
      const proxied = frame.getAttribute('src');
      if (proxied) { try { frame.contentWindow.location.reload(); } catch { frame.src = proxied; } }
      else {
        const raw = tabs[active].url || ''; if (!raw) return;
        addr.dataset.raw = raw; setAddressBar(raw, {force:true});
        if (form.requestSubmit) form.requestSubmit(); else form.dispatchEvent(new Event('submit', { bubbles:true, cancelable:true }));
      }
    });

    inspectBtn.addEventListener('click', ()=>{ /* optional inspector kept as stub */ });

    form.addEventListener('submit',()=>{
      const n = normalizeInput(addr.value);
      if (active>=0) { tabs[active].url = n; addr.dataset.raw = n; }
      setAddressBar(n, {force:true});
      userEditing=false;
      frame.style.display='block'; home.style.display='none';
      setTimeout(updateTabMetaFromFrame, 700);
    }, true);

    function applyFavicon(candidates){
      const headerFav = document.getElementById('site-favicon');
      const tabImg = tabs[active]?.el.querySelector('.fav');
      if (headerFav){ headerFav.referrerPolicy='no-referrer'; headerFav.crossOrigin='anonymous'; }
      if (tabImg){ tabImg.referrerPolicy='no-referrer'; tabImg.crossOrigin='anonymous'; }
      let i=0;
      function next(){
        if(!candidates || i>=candidates.length){ if(headerFav) headerFav.src=DARK_FAV; if(tabImg) tabImg.src=DARK_FAV; return; }
        const src = prox(candidates[i++]);
        if(headerFav){
          headerFav.onerror = next;
          headerFav.onload  = ()=>{ if(tabImg) tabImg.src = headerFav.src; };
          headerFav.src = src;
        }else if(tabImg){
          tabImg.onerror = next;
          tabImg.src = src;
        }
      }
      next();
    }

    function updateTabMetaFromFrame(){
      if (active<0) return;
      let rawTarget = null; try { rawTarget = frame.contentWindow.location.href; } catch {}
      if (!rawTarget) rawTarget = frame.getAttribute('src') || '';
      const target = extractTargetFromScramjet(rawTarget) || addr.dataset.raw || '';
      if (target) { tabs[active].url = target; setAddressBar(target); }

      let didDoc=false;
      try {
        const d = frame.contentDocument;
        if (d) {
          didDoc=true;
          const t = (d.title||'').trim() || new URL(d.URL).hostname.replace(/^www\./,'');
          tabs[active].el.querySelector('.label').textContent = t;

          const out=[]; const base=d.baseURI||d.URL||'';
          const linkEls=[...d.querySelectorAll('link[rel*="icon" i], link[rel="apple-touch-icon" i], link[rel="shortcut icon" i]')];
          linkEls.sort((a,b)=>{
            const sa = parseInt((a.getAttribute('sizes')||'').match(/\d+/)?.[0]||'0',10);
            const sb = parseInt((b.getAttribute('sizes')||'').match(/\d+/)?.[0]||'0',10);
            return sb-sa;
          });
          for(const el of linkEls){ const href=el.getAttribute('href'); if (!href) continue; try{ out.push(new URL(href, base).href); }catch{} }
          try{ const o=new URL(base).origin; out.push(o+'/favicon.ico', o+'/favicon.png', o+'/apple-touch-icon.png'); }catch{}
          applyFavicon([...new Set(out)]);
        }
      } catch {}

      if (!didDoc && target){
        try {
          const u=new URL(target);
          tabs[active].el.querySelector('.label').textContent = u.hostname.replace(/^www\./,'');
          applyFavicon([u.origin+'/favicon.ico', u.origin+'/favicon.png', u.origin+'/apple-touch-icon.png']);
        } catch {}
      }
    }

    frame.addEventListener('load', ()=>setTimeout(updateTabMetaFromFrame, 150));
    setInterval(updateTabMetaFromFrame, 900);

    function openSettingsAtButton(btn){
      const curTheme = document.documentElement.dataset.theme || 'dark';
      const curGrad  = (curTheme==='light'
        ? localStorage.getItem(LS_KEY_GRAD_LIGHT)
        : localStorage.getItem(LS_KEY_GRAD_DARK)) || defaultGradFor(curTheme);

      document.querySelectorAll('.chip[data-group="theme"]').forEach(el=>{
        el.dataset.active = (el.dataset.value===curTheme?'1':'0');
      });

      document.querySelectorAll('.swatch').forEach(el=>{
        el.dataset.active = (el.dataset.value===curGrad?'1':'0');
      });

      const r = btn.getBoundingClientRect();
      const pop = settingsPop;
      const margin = 8;
      pop.style.display = 'block';
      const popW = pop.offsetWidth || 360;
      pop.style.display = 'none';

      const left = Math.max(10, Math.min(window.innerWidth - popW - 10, r.left + r.width - popW));
      pop.style.left = left + 'px';
      pop.style.top  = (r.bottom + margin) + 'px';
      pop.style.display = 'block';

      const onDocClick = (e)=>{
        if (!pop.contains(e.target) && e.target !== btn) {
          pop.style.display='none';
          document.removeEventListener('mousedown', onDocClick, true);
          document.removeEventListener('keydown', onEsc, true);
        }
      };
      const onEsc = (e)=>{ if (e.key==='Escape'){ pop.style.display='none'; document.removeEventListener('mousedown', onDocClick, true); document.removeEventListener('keydown', onEsc, true);} };
      setTimeout(()=>{ document.addEventListener('mousedown', onDocClick, true); document.addEventListener('keydown', onEsc, true); },0);
    }

    document.getElementById('settings').addEventListener('click', ()=> {
      openSettingsAtButton(document.getElementById('settings'));
      applyGradientToUIActiveState();
    });

    document.querySelectorAll('.chip[data-group="theme"]').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        const val = ch.dataset.value;
        applyTheme(val);
        repaintSettings(val);
        applyGradientToUIActiveState();
        document.querySelectorAll('.chip[data-group="theme"]').forEach(el=>{ el.dataset.active = (el===ch?'1':'0'); });
      });
    });

    document.querySelectorAll('.swatch').forEach(sw=>{
      sw.addEventListener('click', ()=>{
        const theme = document.documentElement.dataset.theme || 'dark';
        const val = sw.dataset.value;
        if (!gradientBelongsToTheme(val, theme)) return;
        setGradientVars(val);
        localStorage.setItem(theme==='light' ? LS_KEY_GRAD_LIGHT : LS_KEY_GRAD_DARK, val);
        document.body.style.background = buildBodyBackground(theme);
        applyGradientToUIActiveState();
      });
    });

    document.getElementById('chrome-toggle').addEventListener('click', ()=>{
      const now = !(document.documentElement.dataset.collapsed === '1');
      setCollapsed(now);
    });
    document.getElementById('chrome-fab')?.addEventListener('click', ()=>{
      const now = !(document.documentElement.dataset.collapsed === '1');
      setCollapsed(now);
    });

    addTab(); updateHome(); measureChrome();
  });
</script>
</head>

<body>
  <div class="chrome" role="navigation" aria-label="Browser controls">
    <div class="row tabs">
      <div class="tabs-wrap" id="tabs" role="tablist" aria-label="Tabs">
        <button id="tab-add" class="tab-add" title="New tab">+</button>
      </div>
    </div>
    <div class="row">
      <div class="omnibox">
        <button id="reload"  class="btn icon" title="Reload">↻</button>
        <button id="inspect" class="btn icon" title="Inspect (toggle)">&lt;/&gt;</button>
        <button id="settings" class="btn icon" title="Settings">⚙️</button>
        <button id="chrome-toggle" class="btn icon" title="Collapse" aria-label="Collapse">–</button>
        <img id="site-favicon" alt="" src="" referrerpolicy="no-referrer" crossorigin="anonymous" />
        <form id="sj-form" class="bar" autocomplete="off" role="search">
          <input id="sj-search-engine" type="hidden" value="https://www.google.com/search?q=%s" />
          <input id="sj-address" type="text" placeholder="URL or search…" spellcheck="false" inputmode="url" />
        </form>
      </div>
    </div>
  </div>

  <button id="chrome-fab" class="btn icon fab" title="Expand" aria-label="Expand">+</button>

  <main class="home" id="home">
    <div class="hero">
      <h1 class="title">PROJECT TRINITY</h1>
      <p class="subtitle">1.1.4</p>
      <div class="links">
        <a href="credits.html">Credits</a><span>·</span>
        <a href="https://github.com/MercuryWorkshop" target="_blank" rel="noopener">Github</a><span>·</span>
        <a href="https://www.trinity.gt.tc" target="_blank" rel="noopener">TRINITY</a><span>·</span>
        <span>PT © 2025</span>
      </div>
    </div>
  </main>

  <iframe id="sj-frame"></iframe>

  <p id="sj-error"></p>
  <pre id="sj-error-code"></pre>

  <!-- Settings Popover -->
  <div id="settings-pop" class="settings-pop" role="dialog" aria-modal="false" aria-labelledby="settings-title">
    <div class="settings-group">
      <h4 id="settings-title">Theme</h4>
      <div class="settings-row">
        <button class="chip" data-group="theme" data-value="dark">Dark</button>
        <button class="chip" data-group="theme" data-value="light">Light</button>
      </div>
    </div>
    <div class="settings-group">
      <h4>Gradient</h4>
      <div class="settings-row">
        <!-- Dark set (6) -->
        <div class="swatch" data-theme="dark" data-value="graphite" style="background:linear-gradient(180deg,#0a0a0a,#0d0d0d 55%,#121212)"></div>
        <div class="swatch" data-theme="dark" data-value="abyss"    style="background:linear-gradient(180deg,#0a0f1a,#0b1320 55%,#0c1726)"></div>
        <div class="swatch" data-theme="dark" data-value="violet"   style="background:linear-gradient(180deg,#120a1a,#1a0f2b 55%,#23143a)"></div>
        <div class="swatch" data-theme="dark" data-value="teal"     style="background:linear-gradient(180deg,#071a1a,#0a2222 55%,#0d2a2a)"></div>
        <div class="swatch" data-theme="dark" data-value="slate"    style="background:linear-gradient(180deg,#0c0d10,#101218 55%,#141820)"></div>
        <div class="swatch" data-theme="dark" data-value="obsidian" style="background:linear-gradient(180deg,#0b0c0e,#101318 55%,#171b22)"></div>
        <!-- Light set (6) -->
        <div class="swatch" data-theme="light" data-value="paper"   style="background:linear-gradient(180deg,#f6f7f9,#eef0f4 55%,#e7eaf0)"></div>
        <div class="swatch" data-theme="light" data-value="linen"   style="background:linear-gradient(180deg,#faf7f2,#f2eadf 55%,#e7dcc9)"></div>
        <div class="swatch" data-theme="light" data-value="dawn"    style="background:linear-gradient(180deg,#fdf3f0,#f9e7e2 55%,#f0d9d2)"></div>
        <div class="swatch" data-theme="light" data-value="sky"     style="background:linear-gradient(180deg,#f3f8ff,#e7f1ff 55%,#dceaff)"></div>
        <div class="swatch" data-theme="light" data-value="mint"    style="background:linear-gradient(180deg,#f2fbf6,#e5f6ee 55%,#d7efe5)"></div>
        <div class="swatch" data-theme="light" data-value="pearl"   style="background:linear-gradient(180deg,#ffffff,#f6f7fb 55%,#eceff6)"></div>
      </div>
    </div>
  </div>
</body>
</html>
