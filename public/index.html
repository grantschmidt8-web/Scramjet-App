<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PROJECT TRINITY</title>
<link rel="shortcut icon" content="favicon.webp" />

<style>
  :root{ --fg:#fff; --bg:#000; --chrome-h:84px; }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{ margin:0; background:var(--bg); color:var(--fg); font:14px/1.35 "Courier New",ui-monospace,monospace }

  /* ===== Fixed, edge-to-edge header (tabs row + address row) ===== */
  .chrome{
    position:fixed; inset:0 0 auto 0; z-index:10000;
    background:#000; border-bottom:1px solid #fff;
  }
  .row{ display:flex; align-items:center; gap:8px; padding:6px 8px; }
  .row.tabs{ border-bottom:1px solid #fff; }
  .tabs-wrap{
    flex:1 1 auto; display:flex; align-items:center; gap:6px;
    overflow-x:auto; scrollbar-width:none; -ms-overflow-style:none;
  }
  .tabs-wrap::-webkit-scrollbar{ display:none }

  .tab{
    display:flex; align-items:center; gap:6px;
    padding:4px 10px; border:1px solid #444; border-bottom-color:#fff;
    border-radius:10px 10px 0 0; background:#000; cursor:pointer;
    white-space:nowrap; max-width:220px; user-select:none; transform:translateY(1px);
  }
  .tab span.label{ overflow:hidden; text-overflow:ellipsis }
  .tab.active{ border-color:#fff; border-bottom-color:#000; }
  .tab .close{ cursor:pointer; opacity:.9 }

  .tab-add{
    flex:0 0 auto; border:1px solid #fff; border-radius:50%;
    width:26px; height:26px; line-height:24px; text-align:center;
    background:#000; color:#fff; cursor:pointer; font-size:16px;
  }
  .tab-add:hover{ background:#111 }

  /* Address row under tabs */
  .omnibox{
    flex:1 1 auto; display:flex; align-items:center; gap:8px;
  }
  .btn{
    border:1px solid #fff; background:#000; color:#fff; border-radius:6px;
    height:30px; min-width:30px; padding:0 8px; cursor:pointer;
  }
  .btn:hover{ background:#111 }
  .reload{ font-weight:700 }
  .bar{
    flex:1 1 auto; display:flex; align-items:center;
    border:1px solid #fff; border-radius:16px; padding:6px 10px;
  }
  #sj-address{
    all:unset; color:#fff; width:100%;
    font:14px/1.3 "Courier New",ui-monospace,monospace;
  }
  #sj-address::placeholder{ color:#bfbfbf }
  .bar:focus-within{ outline:2px solid #fff; outline-offset:2px }

  /* Home (shown when active tab has no URL) */
  .home{ padding:24px 18px; max-width:980px; margin:calc(var(--chrome-h) + 20px) auto 16vh; }
  .home .title{ margin:0 0 8px; font-size:28px; font-weight:700 }
  .home .subtitle{ margin:0 0 14px; color:#ddd; font-size:12px }
  .links{ margin-top:12px; display:flex; gap:10px; align-items:center; font-size:12px }
  .links a{ color:#fff; text-decoration:none; border-bottom:1px solid transparent }
  .links a:hover{ border-bottom-color:#fff }

  /* Keep error hooks but hide visually */
  #sj-error,#sj-error-code{ display:none }

  /* Single results surface sized below the fixed header */
  #sj-frame{
    border:none; position:fixed; left:0; right:0;
    top:var(--chrome-h); height:calc(100vh - var(--chrome-h));
    width:100vw; background:#000; z-index:9999; display:none; /* runtime may also toggle */
  }

  @media (max-width:720px){
    :root{ --chrome-h:114px } /* rows wrap taller on small screens */
    .tab{ max-width:160px }
  }
</style>

<!-- Runtime/transport (fix paths if not at site root) -->
<script src="/scram/scramjet.all.js"></script>
<script src="/baremux/index.js" defer></script>
<script src="/epoxy/index.js" defer></script>

<!-- Wisp client (safe if unused) -->
<script src="https://unpkg.com/wisp-js/dist/wisp.min.js" defer></script>

<script src="register-sw.js" defer></script>
<script src="search.js" defer></script>
<script src="index.js" defer></script>

<script>
  /* Default WISP_URL if you didn't set it and you're on HTTPS */
  (function(){ if (!('WISP_URL' in window) && location.protocol==='https:') window.WISP_URL='wss://'+location.host+'/wisp/'; })();

  /* Measure header height → push iframe under it */
  function measureChrome(){
    const c=document.querySelector('.chrome'); if(!c) return;
    document.documentElement.style.setProperty('--chrome-h', Math.ceil(c.getBoundingClientRect().height)+'px');
  }
  addEventListener('resize',measureChrome);
  addEventListener('DOMContentLoaded',measureChrome);

  /* Normalize input to https or search */
  function normalizeInput(q){
    q=(q||'').trim();
    if(!/^[a-z][a-z0-9+.-]*:\/\//i.test(q) && !q.includes('.')) return 'https://www.google.com/search?q='+encodeURIComponent(q);
    if(!/^[a-z][a-z0-9+.-]*:\/\//i.test(q) &&  q.includes('.')) return 'https://'+q;
    return q.replace(/^http:\/\//i,'https://');
  }

  /* Pretty tab titles: brand map + TitleCase fallback */
  const BRAND_MAP = {
    'tiktok.com':'TikTok','youtube.com':'YouTube','youtu.be':'YouTube',
    'instagram.com':'Instagram','x.com':'X','twitter.com':'Twitter',
    'facebook.com':'Facebook','reddit.com':'Reddit','wikipedia.org':'Wikipedia',
    'github.com':'GitHub','google.com':'Google','openai.com':'OpenAI'
  };
  function titleCaseHost(host){
    // keep last two labels usually (e.g., sub.example.com -> example.com)
    const parts = host.split('.'); const core = parts.slice(-2).join('.');
    if (BRAND_MAP[host]) return BRAND_MAP[host];
    if (BRAND_MAP[core]) return BRAND_MAP[core];
    // Fallback: TitleCase first label
    const first = (parts[0] || '').replace(/^www$/i,'') || (parts[parts.length-2]||'');
    return first.replace(/[-_]+/g,' ')
                .replace(/\b[a-z]/g, m => m.toUpperCase());
  }
  function labelFrom(urlOrQuery){
    try {
      const u = new URL(urlOrQuery);
      return titleCaseHost(u.hostname);
    } catch {
      if ((urlOrQuery||'').startsWith('https://www.google.com/search?q=')) return 'Search';
      return (urlOrQuery && urlOrQuery.length>24) ? urlOrQuery.slice(0,24)+'…' : (urlOrQuery || 'New Tab');
    }
  }

  /* Tabs + single iframe flow */
  addEventListener('DOMContentLoaded',()=>{
    const tabsWrap = document.getElementById('tabs');
    const addBtn   = document.getElementById('tab-add');
    const form     = document.getElementById('sj-form');
    const addr     = document.getElementById('sj-address');
    const frame    = document.getElementById('sj-frame');
    const home     = document.getElementById('home');
    const reloadBtn= document.getElementById('reload');

    let tabs=[];          // { id, el, url }
    let active=-1;
    let nextId=1;

    function updateHome(){
      const show = (!tabs.length || !tabs[active]?.url);
      home.style.display = show ? 'block' : 'none';
      if (show) { frame.removeAttribute('src'); frame.style.display='none'; }
      measureChrome();
    }
    function setActive(idx){
      if (idx===active || idx<0 || idx>=tabs.length) return;
      if (active>=0) tabs[active].el.classList.remove('active');
      active=idx;
      tabs[active].el.classList.add('active');
      const url=tabs[active].url||'';
      if (url) { frame.src=url; frame.style.display='block'; }
      addr.placeholder = url ? labelFrom(url) : 'URL or search…';
      updateHome();
    }
    function addTab(initialUrl){
      const id=nextId++;
      const el=document.createElement('div');
      el.className='tab'; el.dataset.id=id;
      el.innerHTML=`<span class="label">New Tab</span><span class="close" title="Close">×</span>`;
      tabsWrap.insertBefore(el, addBtn);

      const tab={ id, el, url: initialUrl||'' };
      if (tab.url) el.querySelector('.label').textContent = labelFrom(tab.url);
      tabs.push(tab);

      el.addEventListener('click',(e)=>{
        if (e.target?.classList?.contains('close')) return;
        const idx=tabs.findIndex(t=>t.id===id); setActive(idx);
      });
      el.querySelector('.close').addEventListener('click',(e)=>{
        e.stopPropagation(); closeTabById(id);
      });

      setActive(tabs.length-1);
    }
    function closeTabById(id){
      const idx=tabs.findIndex(t=>t.id===id);
      if (idx===-1) return;
      const wasActive=(idx===active);
      tabs[idx].el.remove();
      tabs.splice(idx,1);
      if (!tabs.length){ addTab(); return; }
      if (wasActive) setActive(Math.max(0,idx-1));
      else if (idx<active) active-=1;
      updateHome();
    }

    addBtn.addEventListener('click',()=>addTab());

    // Reload button: hard refresh the current iframe URL (if any)
    reloadBtn.addEventListener('click',()=>{
      if (!tabs.length || active<0) return;
      const url = tabs[active].url || '';
      if (url) frame.src = url; // force reload
    });

    // Normalize BEFORE your existing submit handler; remember URL per tab
    form.addEventListener('submit',()=>{
      const n = normalizeInput(addr.value);
      addr.value = n; // search.js reads this
      if (active>=0) {
        tabs[active].url = n;
        tabs[active].el.querySelector('.label').textContent = labelFrom(n);
      }
      frame.style.display = 'block';
      home.style.display  = 'none';
    }, true);

    addTab(); updateHome();
  });
</script>
</head>

<body>
  <!-- Fixed header -->
  <div class="chrome" role="navigation" aria-label="Browser controls">
    <!-- Row 1: Tabs -->
    <div class="row tabs">
      <div class="tabs-wrap" id="tabs" role="tablist" aria-label="Tabs">
        <!-- tabs inserted dynamically -->
        <button id="tab-add" class="tab-add" title="New tab">+</button>
      </div>
    </div>
    <!-- Row 2: Address (omnibox) under the tabs, Chrome-style -->
    <div class="row">
      <div class="omnibox">
        <button id="reload" class="btn reload" title="Reload">↻</button>
        <form id="sj-form" class="bar" autocomplete="off" role="search" style="margin:0;">
          <input id="sj-search-engine" type="hidden" value="https://www.google.com/search?q=%s" />
          <input id="sj-address" type="text" placeholder="URL or search…" spellcheck="false" inputmode="url" />
        </form>
      </div>
    </div>
  </div>

  <!-- Home (visible when active tab has no URL) -->
  <main class="home" id="home">
    <h1 class="title">PROJECT TRINITY</h1>
    <p class="subtitle">Black & white. Chrome-style tabs & omnibox. Just a box that works.</p>
    <div class="links">
      <a href="credits.html">Credits</a><span>·</span>
      <a href="https://github.com/MercuryWorkshop" target="_blank" rel="noopener">Github</a><span>·</span>
      <a href="https://www.trinity.gt.tc" target="_blank" rel="noopener">TRINITY</a><span>·</span>
      <span>PT © 2025</span>
    </div>
  </main>

  <!-- Single iframe under the fixed header -->
  <iframe id="sj-frame"></iframe>

  <!-- Hooks (kept, visually hidden) -->
  <p id="sj-error"></p>
  <pre id="sj-error-code"></pre>
</body>
</html>
