<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PROJECT TRINITY</title>
<link rel="shortcut icon" content="favicon.webp" />

<style>
  :root{
    --fg:#e6e6e6; --fg-dim:#bdbdbd; --bg:#0a0a0a;
    --grad-1:#0a0a0a; --grad-2:#0d0d0d; --grad-3:#121212;
    --stroke:#262626; --accent:#8a8a8a; --chrome-h:96px; --radius:14px; --tab-h:34px;
    --shadow:0 10px 26px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.03);
  }
  *{ box-sizing:border-box } html,body{ height:100% }
  body{
    margin:0; color:var(--fg);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans";
    background:
      radial-gradient(1100px 520px at 80% -10%, rgba(140,140,140,.10) 0%, rgba(0,0,0,0) 60%),
      radial-gradient(900px 480px at -10% 110%, rgba(160,160,160,.08) 0%, rgba(0,0,0,0) 60%),
      linear-gradient(180deg, var(--grad-1) 0%, var(--grad-2) 55%, var(--grad-3) 100%);
  }

  /* Header / tabs / buttons (same as your last good version) */
  .chrome{position:fixed; inset:0 0 auto 0; z-index:10000; backdrop-filter:saturate(120%) blur(10px);
    background:linear-gradient(180deg, rgba(18,18,18,.82), rgba(12,12,12,.68));
    border-bottom:1px solid var(--stroke); box-shadow:var(--shadow); transform:translateY(0); transition:transform .18s ease;}
  html[data-collapsed="1"] .chrome{ transform:translateY(-110%); pointer-events:none; }
  .row{ display:flex; align-items:center; gap:10px; padding:10px 12px; }
  .row.tabs{ padding:8px 12px 0; border-bottom:1px solid var(--stroke); align-items:flex-end; overflow:hidden; }
  .tabs-wrap{ flex:1 1 auto; display:flex; align-items:flex-end; gap:8px; overflow-x:auto; padding:0 6px; scrollbar-width:none; -ms-overflow-style:none; }
  .tabs-wrap::-webkit-scrollbar{ display:none }
  .tab, .tab-add{ height:var(--tab-h); position:relative; display:flex; align-items:center; gap:8px; max-width:260px; white-space:nowrap; cursor:pointer; user-select:none;
    padding:0 12px; border:1px solid var(--stroke); border-bottom-color:transparent; border-radius:18px 18px 0 0;
    background:linear-gradient(180deg, rgba(28,28,28,.92), rgba(18,18,18,.88)); color:var(--fg);
    box-shadow:0 6px 18px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.03);
    margin-bottom:-1px; z-index:1; transition:box-shadow .12s ease, border-color .12s ease, background .12s ease;}
  .tab:hover,.tab-add:hover{ box-shadow:0 10px 26px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04); }
  .tab.active{ border-color:var(--accent); border-bottom-color:#0000; background:linear-gradient(180deg, rgba(32,32,32,.96), rgba(20,20,20,.92));
    box-shadow:0 14px 34px rgba(0,0,0,.6), 0 0 0 1px rgba(255,255,255,.04) inset; z-index:2; }
  .tab .fav{ width:16px; height:16px; border-radius:4px; object-fit:cover; flex:0 0 16px; background:#1a1a1a; border:1px solid #2a2a2a; }
  .tab .label{ overflow:hidden; text-overflow:ellipsis; color:var(--fg) }
  .tab .close{ display:inline-flex; align-items:center; justify-content:center; width:20px; height:20px; border-radius:7px; color:var(--fg-dim); }
  .tab-add{ flex:0 0 auto; max-width:none; gap:6px; font-weight:700; letter-spacing:.4px; }
  .tab-add::before{ content:"+"; display:inline-block; line-height:1; font-size:16px; color:var(--fg); transform: translateY(-1px); }
  .omnibox{ flex:1 1 auto; display:flex; align-items:center; gap:10px; padding:6px 12px; min-width:0; }
  .btn{ border:1px solid var(--stroke); background:linear-gradient(180deg, rgba(26,26,26,.95), rgba(18,18,18,.9)); color:var(--fg);
    border-radius:10px; height:34px; min-width:34px; padding:0 10px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.03), 0 6px 18px rgba(0,0,0,.45); }
  .btn.icon{ width:34px; min-width:34px; padding:0; font-size:16px; }
  .btn.toggled{ outline:2px solid rgba(255,255,255,.08) }
  #site-favicon{ width:18px; height:18px; border-radius:4px; object-fit:cover; background:#1a1a1a; border:1px solid #2a2a2a; }

  .bar{ flex:1 1 420px; max-width:100%; min-width:160px; display:flex; align-items:center; gap:8px; border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(24,24,24,.92), rgba(16,16,16,.9)); border-radius:999px; padding:8px 14px; margin:0;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.03), 0 6px 18px rgba(0,0,0,.45); }

  #sj-address{ all:unset; color:var(--fg); -webkit-text-fill-color:var(--fg); caret-color:var(--fg); width:100%;
    font:14px/1.3 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; }
  #sj-address::placeholder{ color:var(--fg-dim); opacity:.85; }

  .sugg-wrap{ position:relative; flex:1 1 auto; min-width:160px; }
  #omnibox-suggestions{ position:absolute; left:0; right:0; top:calc(100% + 6px); margin:0; padding:6px; list-style:none; z-index:10006;
    border:1px solid var(--stroke); border-radius:12px; background:linear-gradient(180deg, rgba(24,24,24,.98), rgba(16,16,16,.94));
    box-shadow:0 16px 40px rgba(0,0,0,.65); max-height:46vh; overflow:auto; display:none; }
  #omnibox-suggestions li{ display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:10px; cursor:pointer; color:var(--fg); border:1px solid transparent; }
  #omnibox-suggestions li small{ color:var(--fg-dim) }
  #omnibox-suggestions li .fav{ width:16px; height:16px; border-radius:4px; object-fit:cover; background:#1a1a1a; border:1px solid #2a2a2a; flex:0 0 16px; }
  #omnibox-suggestions li[aria-selected="true"]{ border-color:var(--accent); background:linear-gradient(180deg, rgba(34,34,34,.96), rgba(22,22,22,.92)); }

  .home{ max-width:980px; margin:calc(var(--chrome-h) + 28px) auto 18vh; padding:0 18px; }
  html[data-collapsed="1"] .home{ margin:28px auto 18vh; }
  .hero{ padding:24px; border:1px solid var(--stroke); border-radius:var(--radius);
    background:linear-gradient(180deg, rgba(22,22,22,.78), rgba(14,14,14,.72)); box-shadow:var(--shadow); }
  .title{ margin:0 0 10px; font-size:28px; font-weight:800; letter-spacing:.2px; }
  .subtitle{ margin:0; color:var(--fg-dim); font-size:13px }
  .links{ margin-top:14px; display:flex; gap:12px; align-items:center; font-size:12px; color:var(--fg-dim) }
  .links a{ color:var(--fg); text-decoration:none; border-bottom:1px dashed transparent; padding-bottom:1px }

  #sj-error,#sj-error-code{ display:none }

  #sj-frame{
    position:fixed; left:0; right:0; top:var(--chrome-h);
    width:100vw; height:calc(100vh - var(--chrome-h));
    border:none; background:#0b0b0b; z-index:9998; display:none;
    transition:top .18s ease, height .18s ease;
  }
  html[data-collapsed="1"] #sj-frame{ top:0; height:100vh; }

  .fab{ position:fixed; top:10px; right:12px; z-index:10005; border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(26,26,26,.95), rgba(18,18,18,.9)); color:var(--fg);
    border-radius:10px; width:34px; height:34px; display:none; align-items:center; justify-content:center;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.03), 0 6px 18px rgba(0,0,0,.45); cursor:pointer; }
  html[data-collapsed="1"] #chrome-fab{ display:flex; }

  /* tiny self-diagnostic pill */
  #diag{ position:fixed; bottom:10px; right:10px; z-index:10010; font:12px/1.2 ui-monospace,monospace; color:#ccc;
    background:rgba(16,16,16,.9); border:1px solid #2b2b2b; border-radius:10px; padding:8px 10px; display:none; white-space:nowrap; }
  #diag b{ color:#fff }
  #diag .bad{ color:#ff9b9b }
  #diag .ok{ color:#9bffb1 }
</style>

<!-- ===== bootstrap order ===== -->

<!-- 0) Set default WISP endpoint -->
<script>
  if (!("WISP_URL" in window) && location.protocol === "https:") {
    window.WISP_URL = "wss://" + location.host + "/wisp/";
  } else if (!("WISP_URL" in window)) {
    window.WISP_URL = "ws://" + location.host + "/wisp/";
  }
</script>

<!-- 1) Robust BareMux init: probe epoxy paths, ensure clients are ready BEFORE app code runs -->
<script type="module">
  const workerCdn = "https://cdn.jsdelivr.net/npm/@mercuryworkshop/bare-mux/dist/worker.js";
  const clientCdn = "https://cdn.jsdelivr.net/npm/@mercuryworkshop/bare-mux/dist/client.min.js";
  const { BareMux } = await import(clientCdn);

  // Probe which Epoxy path actually exists on your host.
  const candidates = ["/epoxy/index.js", "/epoxy/index.mjs", "/epoxy/"];
  async function firstOk(urls){
    for (const u of urls){
      try{ const r = await fetch(u, { method:"GET", cache:"no-store" }); if (r.ok) return u; }catch(_){}
    }
    return null;
  }
  const epoxyPath = await firstOk(candidates) || "/epoxy/"; // fallback

  const wisp = window.WISP_URL;

  const mux = new BareMux({ worker: workerCdn });

  // Build clients list dynamically: always WISP; add Epoxy if we found it
  const clients = [["wisp", { endpoint: wisp }]];
  if (epoxyPath) clients.push(["epoxy", { endpoint: epoxyPath.replace(/index\.(m)?js$/,'') }]);

  await mux.setClients(clients);
  window.__baremux = mux;

  // Minimal inline diag so we can see what the page discovered
  const box = document.createElement('div');
  box.id = 'diag';
  box.innerHTML = `WISP: <b>${wisp ? '<span class="ok">set</span>' : '<span class="bad">missing</span>'}</b> · `
                + `Epoxy: <b>${epoxyPath ? '<span class="ok">'+epoxyPath+'</span>' : '<span class="bad">not found</span>'}</b>`;
  document.addEventListener('DOMContentLoaded', ()=>{ document.body.appendChild(box); box.style.display='block'; });
  setTimeout(()=> box.remove(), 6000);
</script>

<!-- 2) Scramjet runtime -->
<script src="/scram/scramjet.all.js"></script>

<!-- 3) Epoxy transport (whatever your server serves) -->
<script src="/epoxy/index.js" defer></script>

<!-- 4) Your app plumbing -->
<script src="register-sw.js" defer></script>
<script src="search.js" defer></script>
<script src="index.js" defer></script>
</head>

<body>
  <!-- Header -->
  <div class="chrome" role="navigation" aria-label="Browser controls">
    <div class="row tabs">
      <div class="tabs-wrap" id="tabs" role="tablist" aria-label="Tabs">
        <button id="tab-add" class="tab-add" title="New tab"></button>
      </div>
    </div>
    <div class="row">
      <div class="omnibox">
        <button id="reload"  class="btn icon" title="Reload">↻</button>
        <button id="inspect" class="btn icon" title="Inspect (toggle)">&lt;/&gt;</button>
        <button id="settings" class="btn icon" title="Settings">⚙️</button>
        <button id="chrome-toggle" class="btn icon" title="Collapse" aria-label="Collapse">–</button>
        <img id="site-favicon" alt="" src="" referrerpolicy="no-referrer" crossorigin="anonymous" />
        <div class="sugg-wrap">
          <form id="sj-form" class="bar" autocomplete="off" role="search">
            <input id="sj-search-engine" type="hidden" value="https://www.google.com/search?q=%s" />
            <input id="sj-address" type="text" placeholder="URL or search…" spellcheck="false" inputmode="url" />
          </form>
          <ul id="omnibox-suggestions" role="listbox" aria-label="Suggestions"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Expand FAB (when collapsed) -->
  <button id="chrome-fab" class="btn icon fab" title="Expand" aria-label="Expand">+</button>

  <!-- Home -->
  <main class="home" id="home">
    <div class="hero">
      <h1 class="title">PROJECT TRINITY</h1>
      <p class="subtitle">1.1.4</p>
      <div class="links">
        <a href="credits.html">Credits</a><span>·</span>
        <a href="https://github.com/MercuryWorkshop" target="_blank" rel="noopener">Github</a><span>·</span>
        <a href="https://www.trinity.gt.tc" target="_blank" rel="noopener">TRINITY</a><span>·</span>
        <span>PT © 2025</span>
      </div>
    </div>
  </main>

  <!-- Scramjet surface -->
  <iframe id="sj-frame"
    allow="autoplay; clipboard-read; clipboard-write; encrypted-media; fullscreen; gamepad; geolocation; camera; microphone; midi; payment; picture-in-picture; screen-wake-lock; xr-spatial-tracking">
  </iframe>

  <!-- Hooks -->
  <p id="sj-error"></p>
  <pre id="sj-error-code"></pre>

  <!-- Settings (unchanged UI) -->
  <div id="settings-pop" class="settings-pop" role="dialog" aria-modal="false" aria-labelledby="settings-title">
    <div class="settings-group">
      <h4 id="settings-title">Gradient</h4>
      <div class="settings-row">
        <div class="swatch" data-value="graphite" style="background:linear-gradient(180deg,#0a0a0a,#0d0d0d 55%,#121212)"></div>
        <div class="swatch" data-value="abyss"    style="background:linear-gradient(180deg,#0a0f1a,#0b1320 55%,#0c1726)"></div>
        <div class="swatch" data-value="violet"   style="background:linear-gradient(180deg,#120a1a,#1a0f2b 55%,#23143a)"></div>
        <div class="swatch" data-value="teal"     style="background:linear-gradient(180deg,#071a1a,#0a2222 55%,#0d2a2a)"></div>
        <div class="swatch" data-value="slate"    style="background:linear-gradient(180deg,#0c0d10,#101218 55%,#141820)"></div>
        <div class="swatch" data-value="obsidian" style="background:linear-gradient(180deg,#0b0c0e,#101318 55%,#171b22)"></div>
        <div class="swatch" data-value="onyx"     style="background:linear-gradient(180deg,#0a0a0b,#0e0f11 55%,#141518)"></div>
        <div class="swatch" data-value="nebula"   style="background:linear-gradient(180deg,#0b0b14,#121430 55%,#1a1d47)"></div>
        <div class="swatch" data-value="cyber"    style="background:linear-gradient(180deg,#0a1014,#0b1620 55%,#0d1e2b)"></div>
        <div class="swatch" data-value="oil"      style="background:linear-gradient(180deg,#0a0a0a,#13100d 55%,#1b1612)"></div>
        <div class="swatch" data-value="night"    style="background:linear-gradient(180deg,#080a12,#0b0f1a 55%,#0f1524)"></div>
        <div class="swatch" data-value="carbon"   style="background:linear-gradient(180deg,#0a0a0b,#111213 55%,#191b1d)"></div>
      </div>
    </div>
  </div>

<script>
/* ===== app logic (unchanged from your last working build, but with 2 fixes) =====
   Fix 1: show iframe immediately on navigate and keep updating address bar with full path.
   Fix 2: improved fallback messages when a site refuses being framed (frame-ancestors / x-frame-options).
*/
(function(){
  const DARK_FAV = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect width="24" height="24" rx="4" fill="#222222"/><path d="M6 12h12M12 6v12" stroke="#bdbdbd" stroke-width="1.7" stroke-linecap="round"/></svg>');
  const tabsWrap=document.getElementById('tabs');
  const addBtn=document.getElementById('tab-add');
  const form=document.getElementById('sj-form');
  const addr=document.getElementById('sj-address');
  const frame=document.getElementById('sj-frame');
  const home=document.getElementById('home');
  const reloadBtn=document.getElementById('reload');
  const inspectBtn=document.getElementById('inspect');
  const headerFav=document.getElementById('site-favicon');

  headerFav.src = DARK_FAV;

  function prox(u){ try{ return location.origin + '/scramjet/' + encodeURIComponent(u); }catch{ return u; } }
  function normalizeInput(q){
    q=(q||'').trim();
    if(!/^[a-z][a-z0-9+.-]*:\/\//i.test(q) && !q.includes('.')) return 'https://www.google.com/search?q='+encodeURIComponent(q);
    if(!/^[a-z][a-z0-9+.-]*:\/\//i.test(q) &&  q.includes('.')) return 'https://'+q;
    return q.replace(/^http:\/\//i,'https://');
  }
  function extractTargetFromScramjet(proxiedHref){
    try{
      const u = new URL(proxiedHref, location.origin);
      const parts = u.pathname.split('/scramjet/');
      if (parts.length < 2) return null;
      const remainder = parts[1];
      const cut = remainder.indexOf('/');
      const encodedOrigin = cut === -1 ? remainder : remainder.slice(0, cut);
      const restPath = cut === -1 ? '' : remainder.slice(cut);
      const base = decodeURIComponent(encodedOrigin);
      let finalUrl; try { finalUrl = new URL(restPath || '/', base).href; } catch { finalUrl = base; }
      if (u.hash && !finalUrl.includes('#')) { try { const tmp=new URL(finalUrl); tmp.hash=u.hash; finalUrl=tmp.href; } catch {} }
      return finalUrl.replace(/(?<=https?:\/\/[^/]+)\/{2,}/, '/');
    }catch(_){ return null; }
  }

  let tabs=[]; let active=-1; let nextId=1; let userEditing=false;

  function prettyLabel(urlOrQuery){
    try { const u=new URL(urlOrQuery); const h=u.hostname.replace(/^www\./,''); return h.split('.')[0].replace(/[-_]+/g,' ').replace(/\b[a-z]/g,m=>m.toUpperCase()); }
    catch { return (urlOrQuery||'').slice(0,24) || 'New Tab'; }
  }
  function setAddressBar(raw, opts={force:false}){ if (!opts.force && userEditing) return; addr.value = raw; }
  function updateHome(){
    const show = (!tabs.length || !tabs[active]?.url);
    home.style.display = show ? 'block' : 'none';
    if (show) { frame.removeAttribute('src'); frame.style.display='none'; }
  }

  function addTab(initialUrl){
    const id=nextId++;
    const el=document.createElement('div');
    el.className='tab'; el.dataset.id=id;
    el.innerHTML=`<img class="fav" alt="" src="${DARK_FAV}" referrerpolicy="no-referrer" crossorigin="anonymous"/>
                  <span class="label">New Tab</span>
                  <span class="close" title="Close" aria-label="Close">×</span>`;
    tabsWrap.insertBefore(el, addBtn);
    const tab={ id, el, url: (initialUrl || '') };
    if (tab.url) el.querySelector('.label').textContent = prettyLabel(tab.url);
    tabs.push(tab);
    setActive(tabs.length-1);
  }
  function closeTabById(id){
    const idx=tabs.findIndex(t=>t.id===id); if (idx===-1) return;
    const wasActive=(idx===active); tabs[idx].el.remove(); tabs.splice(idx,1);
    if (!tabs.length){ addTab(); return; }
    if (wasActive) setActive(Math.max(0,idx-1)); else if (idx<active) active-=1;
    updateHome();
  }

  tabsWrap.addEventListener('click', (e) => {
    const closeEl = e.target.closest('.close');
    if (closeEl) { e.preventDefault(); e.stopPropagation(); const tabEl = closeEl.closest('.tab'); if (tabEl) closeTabById(Number(tabEl.dataset.id)); return; }
    const tabEl = e.target.closest('.tab'); if (tabEl) { e.preventDefault(); const idx = tabs.findIndex(t=>t.id===Number(tabEl.dataset.id)); setActive(idx); }
  });
  addBtn.addEventListener('click',()=> addTab());

  function go(raw){
    const n = normalizeInput(raw || '');
    if (!n) return;
    if (active >= 0) {
      tabs[active].url = n;
      tabs[active].el.querySelector('.label').textContent = prettyLabel(n);
    }
    // show surface immediately
    frame.style.display='block'; home.style.display='none';
    setAddressBar(n, {force:true});
    frame.src = prox(n);
  }
  function setActive(idx){
    if (idx===active || idx<0 || idx>=tabs.length) return;
    if (active>=0) tabs[active].el.classList.remove('active');
    active=idx; tabs[active].el.classList.add('active');
    const url=tabs[active].url||'';
    if (url) { go(url); }
    else { addr.value=''; frame.removeAttribute('src'); frame.style.display='none'; home.style.display='block'; }
    updateHome();
  }

  form.addEventListener('submit',(e)=>{ e.preventDefault(); go(addr.value); });
  addr.addEventListener('focus', ()=>{ userEditing = true; });
  addr.addEventListener('input', ()=>{ userEditing = true; });
  addr.addEventListener('blur',  ()=>{ userEditing = false; });

  reloadBtn.addEventListener('click',()=>{
    if (!tabs.length || active<0) return;
    const proxied = frame.getAttribute('src');
    if (proxied) { try { frame.contentWindow.location.reload(); } catch { frame.src = proxied; } }
    else if (tabs[active].url) { go(tabs[active].url); }
  });

  // Update address bar with FULL path (/following etc.)
  function tickMeta(){
    let rawTarget=null; try { rawTarget = frame.contentWindow.location.href; } catch {}
    if (!rawTarget) rawTarget = frame.getAttribute('src') || '';
    const target = extractTargetFromScramjet(rawTarget) || '';
    if (target && active>=0){ tabs[active].url = target; setAddressBar(target); }
  }
  frame.addEventListener('load', ()=> setTimeout(tickMeta, 120));
  setInterval(tickMeta, 900);

  // Basic framed-site failure hints (if a site blocks framing, many browsers show "refused to connect" or an app SW shows "No Internet")
  frame.addEventListener('load', ()=>{
    setTimeout(()=>{
      try{
        const d=frame.contentDocument;
        const t=(d&&d.title||'').toLowerCase();
        if (t.includes('refused to connect') || t.includes('blocked') || t.includes('denied')){
          console.warn('Likely frame-ancestors/X-Frame-Options blocking this site.');
        }
      }catch{
        // cross-origin + no rewriting => might be blocked by CSP/XFO; Scramjet usually rewrites, but if transport failed you’ll land here.
        console.warn('Could not read frame DOM (transport or CSP issue).');
      }
    }, 400);
  });

  // init
  (function init(){ addTab(); })();
})();
</script>
</body>
</html>
