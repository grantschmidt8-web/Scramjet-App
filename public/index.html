<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PROJECT TRINITY</title>
<link rel="shortcut icon" content="favicon.webp" />

<style>
  :root{
    /* Fixed DARK theme tokens (light removed) */
    --fg:#e6e6e6; --fg-dim:#bdbdbd; --bg:#0a0a0a;
    --grad-1:#0a0a0a; --grad-2:#0d0d0d; --grad-3:#121212;
    --stroke:#262626; --accent:#8a8a8a; --chrome-h:96px; --radius:14px; --tab-h:34px;
    --shadow:0 10px 26px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.03);
  }
  *{ box-sizing:border-box } html,body{ height:100% }
  body{
    margin:0; color:var(--fg);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans";
    background:
      radial-gradient(1100px 520px at 80% -10%, rgba(140,140,140,.10) 0%, rgba(140,140,140,0) 60%),
      radial-gradient(900px 480px at -10% 110%, rgba(160,160,160,.08) 0%, rgba(160,160,160,0) 60%),
      linear-gradient(180deg, var(--grad-1) 0%, var(--grad-2) 55%, var(--grad-3) 100%);
  }

  /* ===== Header (collapsible) ===== */
  .chrome{
    position:fixed; inset:0 0 auto 0; z-index:10000;
    backdrop-filter:saturate(120%) blur(10px);
    background:linear-gradient(180deg, rgba(18,18,18,.82), rgba(12,12,12,.68));
    border-bottom:1px solid var(--stroke);
    box-shadow:var(--shadow);
    transform:translateY(0); transition:transform .18s ease;
  }
  html[data-collapsed="1"] .chrome{ transform:translateY(-110%); pointer-events:none; }
  .row{ display:flex; align-items:center; gap:10px; padding:10px 12px; }
  .row.tabs{ padding:8px 12px 0; border-bottom:1px solid var(--stroke); align-items:flex-end; overflow:hidden; }

  .tabs-wrap{
    flex:1 1 auto; display:flex; align-items:flex-end; gap:8px;
    overflow-x:auto; padding:0 6px; scrollbar-width:none; -ms-overflow-style:none;
  }
  .tabs-wrap::-webkit-scrollbar{ display:none }

  .tab, .tab-add{
    height:var(--tab-h);
    position:relative; display:flex; align-items:center; gap:8px;
    max-width:260px; white-space:nowrap; cursor:pointer; user-select:none;
    padding:0 12px; border:1px solid var(--stroke); border-bottom-color:transparent;
    border-radius:18px 18px 0 0;
    background:linear-gradient(180deg, rgba(28,28,28,.92), rgba(18,18,18,.88));
    color:var(--fg);
    box-shadow:0 6px 18px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.03);
    margin-bottom:-1px; z-index:1;
    transition:box-shadow .12s ease, border-color .12s ease, background .12s ease;
  }
  .tab:hover, .tab-add:hover{ box-shadow:0 10px 26px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04); }
  .tab.active{
    border-color:var(--accent); border-bottom-color:#0000;
    background:linear-gradient(180deg, rgba(32,32,32,.96), rgba(20,20,20,.92));
    box-shadow:0 14px 34px rgba(0,0,0,.6), 0 0 0 1px rgba(255,255,255,.04) inset; z-index:2;
  }
  .tab .fav{ width:16px; height:16px; border-radius:4px; object-fit:cover; flex:0 0 16px; background:#1a1a1a; border:1px solid #2a2a2a; }
  .tab .label{ overflow:hidden; text-overflow:ellipsis; color:var(--fg) }
  .tab .close{ display:inline-flex; align-items:center; justify-content:center; width:20px; height:20px; border-radius:7px; color:var(--fg-dim); }

  .tab-add{ flex:0 0 auto; max-width:none; gap:6px; font-weight:700; letter-spacing:.4px; }
  .tab-add::before{ content:"+"; display:inline-block; line-height:1; font-size:16px; color:var(--fg); transform: translateY(-1px); }

  .omnibox{ flex:1 1 auto; display:flex; align-items:center; gap:10px; padding:6px 12px; min-width:0; }
  .btn{
    border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(26,26,26,.95), rgba(18,18,18,.9));
    color:var(--fg); border-radius:10px; height:34px; min-width:34px; padding:0 10px;
    cursor:pointer; display:inline-flex; align-items:center; justify-content:center;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.03), 0 6px 18px rgba(0,0,0,.45);
  }
  .btn.icon{ width:34px; min-width:34px; padding:0; font-size:16px; }
  .btn.toggled{ outline:2px solid rgba(255,255,255,.08) }

  #site-favicon{ width:18px; height:18px; border-radius:4px; object-fit:cover; background:#1a1a1a; border:1px solid #2a2a2a; }

  .bar{
    flex:1 1 420px; max-width:100%; min-width:160px;
    display:flex; align-items:center; gap:8px;
    border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(24,24,24,.92), rgba(16,16,16,.9));
    border-radius:999px; padding:8px 14px; margin:0;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.03), 0 6px 18px rgba(0,0,0,.45);
  }

  /* Address input = dark theme */
  #sj-address{
    all:unset;
    color:var(--fg);
    -webkit-text-fill-color:var(--fg);
    caret-color:var(--fg);
    width:100%;
    font:14px/1.3 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  }
  #sj-address::placeholder{ color:var(--fg-dim); opacity:.85; }

  /* Suggestions */
  .sugg-wrap{ position:relative; flex:1 1 auto; min-width:160px; }
  #omnibox-suggestions{
    position:absolute; left:0; right:0; top:calc(100% + 6px);
    margin:0; padding:6px; list-style:none; z-index:10006;
    border:1px solid var(--stroke); border-radius:12px;
    background:linear-gradient(180deg, rgba(24,24,24,.98), rgba(16,16,16,.94));
    box-shadow:0 16px 40px rgba(0,0,0,.65);
    max-height:46vh; overflow:auto; display:none;
  }
  #omnibox-suggestions li{
    display:flex; align-items:center; gap:10px;
    padding:8px 10px; border-radius:10px; cursor:pointer;
    color:var(--fg); border:1px solid transparent;
  }
  #omnibox-suggestions li small{ color:var(--fg-dim) }
  #omnibox-suggestions li .fav{
    width:16px; height:16px; border-radius:4px; object-fit:cover;
    background:#1a1a1a; border:1px solid #2a2a2a; flex:0 0 16px;
  }
  #omnibox-suggestions li[aria-selected="true"]{
    border-color:var(--accent);
    background:linear-gradient(180deg, rgba(34,34,34,.96), rgba(22,22,22,.92));
  }

  /* Home */
  .home{ max-width:980px; margin:calc(var(--chrome-h) + 28px) auto 18vh; padding:0 18px; }
  html[data-collapsed="1"] .home{ margin:28px auto 18vh; }
  .hero{ padding:24px; border:1px solid var(--stroke); border-radius:var(--radius);
    background:linear-gradient(180deg, rgba(22,22,22,.78), rgba(14,14,14,.72)); box-shadow:var(--shadow); }
  .title{ margin:0 0 10px; font-size:28px; font-weight:800; letter-spacing:.2px; }
  .subtitle{ margin:0; color:var(--fg-dim); font-size:13px }
  .links{ margin-top:14px; display:flex; gap:12px; align-items:center; font-size:12px; color:var(--fg-dim) }
  .links a{ color:var(--fg); text-decoration:none; border-bottom:1px dashed transparent; padding-bottom:1px }

  #sj-error,#sj-error-code{ display:none }

  #sj-frame{
    position:fixed; left:0; right:0; top:var(--chrome-h);
    width:100vw; height:calc(100vh - var(--chrome-h));
    border:none; background:#0b0b0b;
    z-index:9998; display:none;
    transition:top .18s ease, height .18s ease;
  }
  html[data-collapsed="1"] #sj-frame{ top:0; height:100vh; }

  /* Collapse FAB */
  .fab{
    position:fixed; top:10px; right:12px; z-index:10005;
    border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(26,26,26,.95), rgba(18,18,18,.9));
    color:var(--fg); border-radius:10px; width:34px; height:34px;
    display:none; align-items:center; justify-content:center;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.03), 0 6px 18px rgba(0,0,0,.45);
    cursor:pointer;
  }
  html[data-collapsed="1"] #chrome-fab{ display:flex; }

  /* Settings pop (dark-only, more gradients) */
  .settings-pop{
    position:fixed; z-index:10004; display:none;
    border:1px solid var(--stroke); border-radius:12px; padding:12px;
    background:linear-gradient(180deg, rgba(24,24,24,.98), rgba(16,16,16,.94));
    box-shadow:var(--shadow); color:var(--fg); width:min(520px, calc(100vw - 20px));
  }
  .settings-pop h4{ margin:0 0 8px; font-size:14px; }
  .settings-group{ margin-bottom:10px; }
  .settings-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .swatch{
    width:84px; height:40px; border-radius:10px; border:2px solid var(--stroke);
    cursor:pointer; position:relative; box-shadow:inset 0 1px 0 rgba(255,255,255,.03);
    transition:border-color .12s ease, box-shadow .12s ease, transform .12s ease;
  }
  .swatch:hover{ border-color: var(--accent); box-shadow:inset 0 1px 0 rgba(255,255,255,.05), 0 6px 18px rgba(0,0,0,.35); transform: translateY(-1px); }
  .swatch[data-active="1"]{ border-color: var(--accent); box-shadow:inset 0 1px 0 rgba(255,255,255,.06), 0 10px 26px rgba(0,0,0,.45); }
  .swatch[data-active="1"]::after{ content:"✓"; position:absolute; right:8px; bottom:6px; font-size:14px; opacity:.9; }
</style>

<!-- 1) Force absolute WISP endpoint early (before any client loads) -->
<script>
  window.WISP_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/wisp/';
</script>

<!-- Runtime/transport -->
<script src="/scram/scramjet.all.js"></script>
<script src="/baremux/index.js" defer></script>
<script src="/epoxy/index.js" defer></script>
<script src="https://unpkg.com/wisp-js/dist/wisp.min.js" defer></script>
<script src="register-sw.js" defer></script>
<script src="search.js" defer></script>
<script src="index.js" defer></script>

<script>
  /* Force WISP default over HTTPS (kept for redundancy) */
  (function(){ if (!('WISP_URL' in window) && location.protocol==='https:') window.WISP_URL='wss://'+location.host+'/wisp/'; })();

  /* === Storage keys (dark-only) === */
  const LS_KEY_COLLAPSE = 'pt_chrome_collapsed';
  const LS_KEY_GRAD     = 'pt_gradient_dark';

  /* === Favicon fallbacks (dark only) === */
  const DARK_FAV = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect width="24" height="24" rx="4" fill="#222222"/><path d="M6 12h12M12 6v12" stroke="#bdbdbd" stroke-width="1.7" stroke-linecap="round"/></svg>');
  const DEF_FAV  = () => DARK_FAV;

  function proxAsset(u){ try { return location.origin + '/scramjet/' + encodeURIComponent(u); } catch { return u; } }
  function favCandidates(urlOrHost){
    let host = '';
    try { host = new URL(urlOrHost).hostname; }
    catch { host = String(urlOrHost||'').replace(/^https?:\/\//i,'').replace(/\/.*$/,''); }
    host = host.replace(/^www\./i,'');
    if (!host) return [];
    const abs = (p)=>`https://${host}${p}`;
    return [
      abs('/favicon.ico'),
      abs('/favicon.png'),
      abs('/apple-touch-icon.png'),
      `https://www.google.com/s2/favicons?sz=64&domain=${encodeURIComponent(host)}`
    ].map(proxAsset);
  }
  function loadFaviconInto(imgEl, candidates, fallback){
    if (!imgEl) return;
    imgEl.referrerPolicy='no-referrer'; imgEl.crossOrigin='anonymous';
    const fb = fallback || DARK_FAV;
    const list = Array.from(new Set(candidates || []));
    if (!list.length){ imgEl.src = fb; return; }
    let i=0;
    const next=()=>{ if (i>=list.length){ imgEl.src=fb; return; }
      const src=list[i++]; imgEl.onerror=next; imgEl.onload=()=>{ imgEl.onerror=null; }; imgEl.src=src; };
    next();
  }

  /* === Dark gradients (12) === */
  const GRADS = {
    graphite:{ sw:['#0a0a0a','#0d0d0d','#121212'] },
    abyss:   { sw:['#0a0f1a','#0b1320','#0c1726'] },
    violet:  { sw:['#120a1a','#1a0f2b','#23143a'] },
    teal:    { sw:['#071a1a','#0a2222','#0d2a2a'] },
    slate:   { sw:['#0c0d10','#101218','#141820'] },
    obsidian:{ sw:['#0b0c0e','#101318','#171b22'] },
    onyx:    { sw:['#0a0a0b','#0e0f11','#141518'] },
    nebula:  { sw:['#0b0b14','#121430','#1a1d47'] },
    cyber:   { sw:['#0a1014','#0b1620','#0d1e2b'] },
    oil:     { sw:['#0a0a0a','#13100d','#1b1612'] },
    night:   { sw:['#080a12','#0b0f1a','#0f1524'] },
    carbon:  { sw:['#0a0a0b','#111213','#191b1d'] }
  };
  function setGradientVars(name){
    const g = GRADS[name] || GRADS.graphite;
    document.documentElement.style.setProperty('--grad-1', g.sw[0]);
    document.documentElement.style.setProperty('--grad-2', g.sw[1]);
    document.documentElement.style.setProperty('--grad-3', g.sw[2]);
  }
  function buildBodyBackground(){
    const g1 = getComputedStyle(document.documentElement).getPropertyValue('--grad-1').trim() || '#0a0a0a';
    const g2 = getComputedStyle(document.documentElement).getPropertyValue('--grad-2').trim() || '#0d0d0d';
    const g3 = getComputedStyle(document.documentElement).getPropertyValue('--grad-3').trim() || '#121212';
    return [
      `radial-gradient(1100px 520px at 80% -10%, rgba(140,140,140,.10) 0%, rgba(0,0,0,0) 60%)`,
      `radial-gradient(900px 480px at -10% 110%, rgba(160,160,160,.08) 0%, rgba(0,0,0,0) 60%)`,
      `linear-gradient(180deg, ${g1} 0%, ${g2} 55%, ${g3} 100%)`
    ].join(', ');
  }
  function applyDarkTheme(){
    document.body.style.color = getComputedStyle(document.documentElement).getPropertyValue('--fg').trim();
    document.body.style.background = buildBodyBackground();
    document.querySelector('.chrome')?.style.setProperty('background','linear-gradient(180deg, rgba(18,18,18,.82), rgba(12,12,12,.68))');
    document.querySelectorAll('.hero').forEach(n=>n.style.setProperty('background','linear-gradient(180deg, rgba(22,22,22,.78), rgba(14,14,14,.72))'));
    document.querySelectorAll('.bar').forEach(n=>n.style.setProperty('background','linear-gradient(180deg, rgba(24,24,24,.92), rgba(16,16,16,.9))'));
    document.querySelectorAll('.btn').forEach(n=>n.style.setProperty('background','linear-gradient(180deg, rgba(26,26,26,.95), rgba(18,18,18,.9))'));
    document.querySelectorAll('.tab').forEach(n=>n.style.setProperty('background','linear-gradient(180deg, rgba(28,28,28,.92), rgba(18,18,18,.88))'));
    document.querySelectorAll('.tab.active').forEach(n=>n.style.setProperty('background','linear-gradient(180deg, rgba(32,32,32,.96), rgba(20,20,20,.92))'));
    document.getElementById('sj-frame')?.style.setProperty('background','#0b0b0b');

    const addrEl = document.getElementById('sj-address');
    if (addrEl) {
      const fg = getComputedStyle(document.documentElement).getPropertyValue('--fg').trim();
      addrEl.style.webkitTextFillColor = fg;
      addrEl.style.caretColor = fg;
    }
    const headerFav = document.getElementById('site-favicon');
    if (headerFav && (!headerFav.src || headerFav.src === DARK_FAV)) headerFav.src = DARK_FAV;
    document.querySelectorAll('.tab .fav').forEach(img=>{
      if (!img.getAttribute('data-has-real') && (!img.src || img.src===DARK_FAV)) img.src = DARK_FAV;
    });
    document.querySelectorAll('#omnibox-suggestions li').forEach(li=>{
      if (li.dataset.hasHostIcon !== '1') {
        const img = li.querySelector('img.fav'); if (img) img.src = DARK_FAV;
      }
    });
  }

  function measureChrome(){
    const collapsed = document.documentElement.dataset.collapsed === '1';
    const c=document.querySelector('.chrome');
    const h = (collapsed || !c) ? 0 : Math.ceil(c.getBoundingClientRect().height);
    document.documentElement.style.setProperty('--chrome-h', h+'px');
  }
  function setCollapsed(on){
    document.documentElement.dataset.collapsed = on ? '1' : '0';
    localStorage.setItem(LS_KEY_COLLAPSE, on ? '1' : '0');
    const t=document.getElementById('chrome-toggle');
    const fab=document.getElementById('chrome-fab');
    if (t){ t.textContent = on ? '+' : '–'; t.title = on ? 'Expand' : 'Collapse'; t.setAttribute('aria-label', t.title); }
    if (fab){ fab.textContent = '+'; fab.title='Expand'; fab.setAttribute('aria-label','Expand'); }
    measureChrome();
  }

  function prox(u){ try{ return location.origin + '/scramjet/' + encodeURIComponent(u); }catch{ return u; } }
  function extractTargetFromScramjet(proxiedHref){
    try{
      const u = new URL(proxiedHref, location.origin);
      const parts = u.pathname.split('/scramjet/');
      if (parts.length < 2) return null;
      const remainder = parts[1];
      const cut = remainder.indexOf('/');
      const encodedOrigin = cut === -1 ? remainder : remainder.slice(0, cut);
      const restPath = cut === -1 ? '' : remainder.slice(cut);
      const base = decodeURIComponent(encodedOrigin);
      let finalUrl; try { finalUrl = new URL(restPath || '/', base).href; } catch { finalUrl = base; }
      if (u.hash && !finalUrl.includes('#')) { try { const tmp=new URL(finalUrl); tmp.hash=u.hash; finalUrl=tmp.href; } catch {} }
      return finalUrl.replace(/(?<=https?:\/\/[^/]+)\/{2,}/, '/');
    }catch(_){ return null; }
  }

  addEventListener('resize',measureChrome);

  addEventListener('DOMContentLoaded',()=>{
    if (!localStorage.getItem(LS_KEY_GRAD)) localStorage.setItem(LS_KEY_GRAD,'graphite');
    setGradientVars(localStorage.getItem(LS_KEY_GRAD));
    applyDarkTheme();

    setCollapsed(localStorage.getItem(LS_KEY_COLLAPSE) === '1');

    const tabsWrap   = document.getElementById('tabs');
    const addBtn     = document.getElementById('tab-add');
    const form       = document.getElementById('sj-form');
    const addr       = document.getElementById('sj-address');
    const frame      = document.getElementById('sj-frame');
    const home       = document.getElementById('home');
    const reloadBtn  = document.getElementById('reload');
    const inspectBtn = document.getElementById('inspect');
    const headerFav  = document.getElementById('site-favicon');
    const settingsBtn= document.getElementById('settings');
    const settingsPop= document.getElementById('settings-pop');
    const toggleBtn  = document.getElementById('chrome-toggle');
    const fabBtn     = document.getElementById('chrome-fab');

    if (headerFav) headerFav.src = DARK_FAV;

    let tabs=[]; let active=-1; let nextId=1; let inspectorOn=false;
    let userEditing=false;

    addr.addEventListener('focus', ()=>{ userEditing = true; });
    addr.addEventListener('input', ()=>{ userEditing = true; });
    addr.addEventListener('blur',  ()=>{ userEditing = false; });

    function prettyLabel(urlOrQuery){
      try { const u=new URL(urlOrQuery); const h=u.hostname.replace(/^www\./,''); return h.split('.')[0].replace(/[-_]+/g,' ').replace(/\b[a-z]/g,m=>m.toUpperCase()); }
      catch { return (urlOrQuery||'').slice(0,24) || 'New Tab'; }
    }
    function normalizeInput(q){
      q=(q||'').trim();
      if(!/^[a-z][a-z0-9+.-]*:\/\//i.test(q) && !q.includes('.')) return 'https://www.google.com/search?q='+encodeURIComponent(q);
      if(!/^[a-z][a-z0-9+.-]*:\/\//i.test(q) &&  q.includes('.')) return 'https://'+q;
      return q.replace(/^http:\/\//i,'https://');
    }
    function setAddressBar(rawUrl, opts={force:false}){
      if (!opts.force && userEditing) return;
      addr.value = rawUrl;
      if (active>=0) tabs[active].el.querySelector('.label').textContent = prettyLabel(rawUrl);
    }
    function clearAddressBar(){ addr.value=''; addr.placeholder='URL or search…'; }

    function updateHome(){
      const show = (!tabs.length || !tabs[active]?.url);
      home.style.display = show ? 'block' : 'none';
      if (show) { frame.removeAttribute('src'); frame.style.display='none'; }
    }

    function addTab(initialUrl){
      const id=nextId++;
      const el=document.createElement('div');
      el.className='tab'; el.dataset.id=id;
      el.innerHTML=`<img class="fav" alt="" src="${DARK_FAV}" referrerpolicy="no-referrer" crossorigin="anonymous"/>
                    <span class="label">New Tab</span>
                    <span class="close" title="Close" aria-label="Close">×</span>`;
      tabsWrap.insertBefore(el, addBtn);
      const tab={ id, el, url: (initialUrl || '') };
      if (tab.url) el.querySelector('.label').textContent = prettyLabel(tab.url);
      tabs.push(tab);
      setActive(tabs.length-1);
      measureChrome();
    }
    function closeTabById(id){
      const idx=tabs.findIndex(t=>t.id===id); if (idx===-1) return;
      const wasActive=(idx===active); tabs[idx].el.remove(); tabs.splice(idx,1);
      if (!tabs.length){ addTab(); return; }
      if (wasActive) setActive(Math.max(0,idx-1)); else if (idx<active) active-=1;
      updateHome();
    }

    tabsWrap.addEventListener('click', (e) => {
      const closeEl = e.target.closest('.close');
      if (closeEl) { e.preventDefault(); e.stopPropagation(); const tabEl = closeEl.closest('.tab'); if (tabEl) closeTabById(Number(tabEl.dataset.id)); return; }
      const tabEl = e.target.closest('.tab'); if (tabEl) { e.preventDefault(); const idx = tabs.findIndex(t=>t.id===Number(tabEl.dataset.id)); setActive(idx); }
    });
    addBtn.addEventListener('click',()=>{ setCollapsed(false); addTab(); });

    function go(raw){
      const n = normalizeInput(raw || '');
      if (!n) return;
      addr.value = n;
      if (active >= 0) {
        tabs[active].url = n;
        tabs[active].el.querySelector('.label').textContent = prettyLabel(n);
      }
      frame.src = prox(n);
      frame.style.display = 'block';
      home.style.display  = 'none';
      setTimeout(updateTabMetaFromFrame, 700);
    }
    window.go = go;

    function setActive(idx){
      if (idx===active || idx<0 || idx>=tabs.length) return;
      if (active>=0) tabs[active].el.classList.remove('active');
      active=idx; tabs[active].el.classList.add('active');
      const url=tabs[active].url||'';
      if (url) { go(url); }
      else { clearAddressBar(); frame.removeAttribute('src'); frame.style.display='none'; home.style.display='block'; }
      updateHome();
    }

    form.addEventListener('submit',(e)=>{ e.preventDefault(); go(addr.value); });
    reloadBtn.addEventListener('click',()=>{
      if (!tabs.length || active<0) return;
      const proxied = frame.getAttribute('src');
      if (proxied) { try { frame.contentWindow.location.reload(); } catch { frame.src = proxied; } }
      else if (tabs[active].url) { go(tabs[active].url); }
    });

    function applyFavicon(candidates){
      const headerFav = document.getElementById('site-favicon');
      const tabImg    = tabs[active]?.el.querySelector('.fav');
      const def       = DARK_FAV;

      const list = [];
      try {
        const d = frame.contentDocument;
        const base = d?.baseURI || frame.contentWindow?.location?.href || tabs[active]?.url || '';
        (candidates||[]).forEach(h=>{ try { list.push(new URL(h, base).href); } catch {} });
      } catch {}
      const proxed = list.map(proxAsset);

      if (headerFav){
        loadFaviconInto(headerFav, proxed, def);
        headerFav.addEventListener('load', ()=>{ headerFav.setAttribute('data-has-real','1'); }, { once:true });
        if (tabImg){
          headerFav.addEventListener('load', ()=>{ tabImg.src = headerFav.src; tabImg.setAttribute('data-has-real','1'); }, { once:true });
          headerFav.addEventListener('error',()=>{ tabImg.src = def; }, { once:true });
        }
      } else if (tabImg){
        loadFaviconInto(tabImg, proxed, def);
        tabImg.addEventListener('load', ()=>{ tabImg.setAttribute('data-has-real','1'); }, { once:true });
      }
    }

    function extractDocIconsAndTitle(){
      let outIcons=[], titleTxt='';
      try {
        const d = frame.contentDocument; if (!d) return {icons:outIcons,title:titleTxt};
        titleTxt = (d.title||'').trim();
        const base=d.baseURI||d.URL||'';
        const linkEls=[...d.querySelectorAll('link[rel*="icon" i], link[rel="apple-touch-icon" i], link[rel="shortcut icon" i]')];
        linkEls.sort((a,b)=>{
          const sa = parseInt((a.getAttribute('sizes')||'').match(/\d+/)?.[0]||'0',10);
          const sb = parseInt((b.getAttribute('sizes')||'').match(/\d+/)?.[0]||'0',10);
          return sb-sa;
        });
        for(const el of linkEls){ const href=el.getAttribute('href'); if (!href) continue; try{ outIcons.push(new URL(href, base).href); }catch{} }
        try{ const o=new URL(base).origin; outIcons.push(o+'/favicon.ico', o+'/favicon.png', o+'/apple-touch-icon.png'); }catch{}
      } catch {}
      return {icons:[...new Set(outIcons)], title:titleTxt};
    }

    function updateTabMetaFromFrame(){
      if (active<0) return;
      let rawTarget = null; try { rawTarget = frame.contentWindow.location.href; } catch {}
      if (!rawTarget) rawTarget = frame.getAttribute('src') || '';
      const target = extractTargetFromScramjet(rawTarget) || '';
      if (target) { tabs[active].url = target; setAddressBar(target); }

      let didDoc=false;
      const got = extractDocIconsAndTitle();
      if (got.title) {
        didDoc=true;
        tabs[active].el.querySelector('.label').textContent = got.title;
        applyFavicon(got.icons);
      }
      if (!didDoc && target){
        try {
          const u=new URL(target);
          tabs[active].el.querySelector('.label').textContent = u.hostname.replace(/^www\./,'');
          applyFavicon(favCandidates(u.origin));
        } catch {}
      }
    }
    frame.addEventListener('load', ()=>setTimeout(updateTabMetaFromFrame, 150));
    setInterval(updateTabMetaFromFrame, 900);

    /* ---- WISP/Mux auto-recover: reconnect when the multiplexer dies ---- */
    function tryRecoverMux(){
      const src = frame && frame.getAttribute('src');
      if (!src) return;
      try { frame.contentWindow.location.reload(); }
      catch { frame.src = src; }
    }
    function onMuxTaskEnded(e){
      const msg = (e?.reason?.message || e?.message || '') + '';
      if (msg.includes('MuxTaskEnded')) tryRecoverMux();
    }
    window.addEventListener('unhandledrejection', onMuxTaskEnded);
    window.addEventListener('error', onMuxTaskEnded);

    /* Inspector stub (kept minimal; enable when you add overlay) */
    function disableInspector(){ inspectorOn=false; document.getElementById('inspect')?.classList.remove('toggled'); }
    function enableInspector(){ try { void frame.contentDocument; } catch { disableInspector(); return; } /* add overlay here if desired */ }
    inspectBtn.addEventListener('click', ()=>{ if (inspectorOn){ try { frame.contentWindow.postMessage({__mini_inspector_cmd:'off'}, '*'); } catch(_){} disableInspector(); } else { enableInspector(); } });

    /* Settings pop (dark-only gradients) */
    function openSettingsAtButton(btn){
      const curGrad = localStorage.getItem(LS_KEY_GRAD) || 'graphite';
      document.querySelectorAll('.swatch').forEach(el=>{ el.dataset.active = (el.dataset.value===curGrad?'1':'0'); });
      const r = btn.getBoundingClientRect(); const margin = 8;
      settingsPop.style.display = 'block'; const popW = settingsPop.offsetWidth || 420; settingsPop.style.display = 'none';
      const left = Math.max(10, Math.min(window.innerWidth - popW - 10, r.left + r.width - popW));
      settingsPop.style.left = left + 'px'; settingsPop.style.top  = (r.bottom + margin) + 'px'; settingsPop.style.display = 'block';
      const onDocClick = (e)=>{ if (!settingsPop.contains(e.target) && e.target !== btn) { settingsPop.style.display='none'; document.removeEventListener('mousedown', onDocClick, true); document.removeEventListener('keydown', onEsc, true); } };
      const onEsc = (e)=>{ if (e.key==='Escape'){ settingsPop.style.display='none'; document.removeEventListener('mousedown', onDocClick, true); document.removeEventListener('keydown', onEsc, true);} };
      setTimeout(()=>{ document.addEventListener('mousedown', onDocClick, true); document.addEventListener('keydown', onEsc, true); },0);
    }
    document.getElementById('settings').addEventListener('click', ()=> openSettingsAtButton(document.getElementById('settings')));
    document.querySelectorAll('.swatch').forEach(sw=>{
      sw.addEventListener('click', ()=>{
        const val = sw.dataset.value;
        if (!GRADS[val]) return;
        setGradientVars(val);
        localStorage.setItem(LS_KEY_GRAD, val);
        document.body.style.background = buildBodyBackground();
        document.querySelectorAll('.swatch').forEach(el=>{ el.dataset.active = (el===sw?'1':'0'); });
      });
    });

    /* Collapse controls */
    toggleBtn.addEventListener('click', ()=>{
      const want = !(document.documentElement.dataset.collapsed === '1');
      setCollapsed(want);
    });
    fabBtn.addEventListener('click', ()=> setCollapsed(false));

    /* Init */
    addTab(); updateHome(); measureChrome();

    /* ---------- Suggestions (local + Google via Scramjet) ---------- */
    const suggEl = document.getElementById('omnibox-suggestions');
    const LS_HISTORY = 'pt_history_urls';

    const COMMON = [
      {label:'YouTube',   url:'https://www.youtube.com'},
      {label:'TikTok',    url:'https://www.tiktok.com'},
      {label:'Instagram', url:'https://www.instagram.com'},
      {label:'Xbox',    url:'https://www.xbox.com/play'},
      {label:'Wikipedia', url:'https://www.wikipedia.org'},
      {label:'GitHub',    url:'https://github.com'},
      {label:'Google',    url:'https://www.google.com'},
      {label:'OpenAI',    url:'https://openai.com'}
    ];

    function loadHistory(){ try { return JSON.parse(localStorage.getItem(LS_HISTORY)||'[]'); } catch { return []; } }
    function saveHistory(url){
      if (!url) return;
      const list = loadHistory().filter(u=>u!==url);
      list.unshift(url); while (list.length>50) list.pop();
      localStorage.setItem(LS_HISTORY, JSON.stringify(list));
    }
    const __oldGo = window.go;
    window.go = function(raw){ __oldGo.call(this, raw); try { const n = normalizeInput((raw||'').trim()); saveHistory(n); } catch {} };

    function currentEngine(){ return document.getElementById('sj-search-engine')?.value || 'https://www.google.com/search?q=%s'; }
    let lastRemoteQ='', lastRemoteOut=[];
    async function fetchGoogle(q){
      const trimmed = (q||'').trim(); if (!trimmed){ lastRemoteOut=[]; return []; }
      if (trimmed === lastRemoteQ) return lastRemoteOut;
      lastRemoteQ = trimmed;
      const url = 'https://suggestqueries.google.com/complete/search?client=firefox&q=' + encodeURIComponent(trimmed);
      try{
        const r = await fetch(proxAsset(url), { credentials:'omit' });
        const data = await r.json();
        const arr = Array.isArray(data) && Array.isArray(data[1]) ? data[1] : [];
        lastRemoteOut = arr.slice(0,8).map(s => {
          const domainish = /^[a-z0-9.-]+\.[a-z]{2,}$/i.test(s.trim());
          const urlGuess  = domainish ? ('https://' + s.trim().replace(/\s+/g,'')) : null;
          return {
            type:'google',
            label:s,
            sub: domainish ? 'Open site' : 'Google suggestion',
            value: domainish ? urlGuess : (currentEngine()).replace('%s', encodeURIComponent(s)),
            hostForIcon: domainish ? urlGuess : null
          };
        });
        return lastRemoteOut;
      }catch{ lastRemoteOut = []; return []; }
    }
    function hostFromUrl(u){ try{ return new URL(u).hostname.replace(/^www\./,''); }catch{ return u; } }

    function localItems(qRaw){
      const q = (qRaw||'').trim();
      const items = [];
      if (!q){
        const hist = loadHistory().slice(0,6).map(u=>({type:'history', label:u, sub:hostFromUrl(u), value:u, hostForIcon:u}));
        const pop  = COMMON.slice(0,6).map(p=>({type:'common', label:p.label, sub:hostFromUrl(p.url), value:p.url, hostForIcon:p.url}));
        return [...hist, ...pop];
      }
      const looksDomainish = /^[a-z0-9.-]+$/i.test(q) && q.includes('.');

      COMMON.forEach(p=>{
        if (p.label.toLowerCase().startsWith(q.toLowerCase()) || p.url.toLowerCase().includes(q.toLowerCase())){
          items.push({type:'brand', label:p.label, sub:p.url, value:p.url, hostForIcon:p.url});
        }
      });

      if (!q.includes(' ') && !/^[a-z][a-z0-9+.-]*:\/\//i.test(q)){
        const dotCom = 'https://' + q.toLowerCase().replace(/\s+/g,'') + '.com';
        items.push({type:'domain', label:dotCom.replace(/^https?:\/\//,''), sub:'Go to site', value:dotCom, hostForIcon:dotCom});
      }
      if (looksDomainish){
        const https = 'https://' + q.replace(/^www\./i,'');
        items.push({type:'domain', label:q.replace(/^www\./i,''), sub:'Go to site', value:https, hostForIcon:https});
      }

      const engine = currentEngine();
      items.push({type:'search', label:q, sub:'Search', value:engine.replace('%s', encodeURIComponent(q))});

      loadHistory().forEach(u=>{
        if (u.toLowerCase().includes(q.toLowerCase()))
          items.push({type:'history', label:u.replace(/^https?:\/\//,''), sub:hostFromUrl(u), value:u, hostForIcon:u});
      });

      return items;
    }

    async function buildItems(q){
      const local = localItems(q);
      const google = await fetchGoogle(q);
      const seen = new Set(), out = [];
      for (const it of [...local, ...google]){
        const key = it.value;
        if (seen.has(key)) continue;
        seen.add(key); out.push(it);
        if (out.length >= 14) break;
      }
      return out;
    }

    let activeIndex = -1, currentItems = [];
    function render(list){
      currentItems = list; activeIndex = -1;
      suggEl.innerHTML = '';
      if (!list.length){ suggEl.style.display='none'; return; }
      for (let i=0;i<list.length;i++){
        const it = list[i];
        const li = document.createElement('li');
        li.setAttribute('role','option'); li.dataset.index = String(i);

        const img = document.createElement('img');
        img.className='fav'; img.alt=''; img.width=16; img.height=16;
        img.referrerPolicy='no-referrer'; img.crossOrigin='anonymous';

        if (it.hostForIcon){
          loadFaviconInto(img, favCandidates(it.hostForIcon), DARK_FAV);
          li.dataset.hasHostIcon = "1";
        } else if (it.iconUrl){
          loadFaviconInto(img, [proxAsset(it.iconUrl)], DARK_FAV);
          li.dataset.hasHostIcon = "1";
        } else {
          img.src = DARK_FAV;
          li.dataset.hasHostIcon = "0";
        }

        const main = document.createElement('span');  main.textContent = it.label;
        const sub  = document.createElement('small'); sub.textContent  = it.sub || '';

        li.appendChild(img); li.appendChild(main); li.appendChild(sub);
        li.addEventListener('mouseenter', ()=>select(i));
        li.addEventListener('mousedown', (e)=>{ e.preventDefault(); });
        li.addEventListener('click', ()=>apply(i));
        suggEl.appendChild(li);
      }
      suggEl.style.display='block';
    }
    function select(i){
      const items = [...suggEl.querySelectorAll('li')];
      items.forEach(n=>n.setAttribute('aria-selected','false'));
      if (i>=0 && i<items.length){
        items[i].setAttribute('aria-selected','true');
        activeIndex = i;
        try { addr.value = decodeURIComponent(currentItems[i].value); } catch { addr.value = currentItems[i].value; }
        addr.setSelectionRange(addr.value.length, addr.value.length);
      }
    }
    function apply(i){
      if (i<0 || i>=currentItems.length) return;
      const val = currentItems[i].value;
      suggEl.style.display='none';
      addr.value = val;
      form.requestSubmit ? form.requestSubmit() : form.dispatchEvent(new Event('submit', {bubbles:true, cancelable:true}));
    }

    let debounce=null, lastQ='';
    async function refresh(q){
      lastQ = q;
      render(localItems(q));
      if (debounce) clearTimeout(debounce);
      debounce = setTimeout(async()=>{
        if (q !== lastQ) return;
        const merged = await buildItems(q);
        if (q === lastQ) render(merged);
      }, 120);
    }

    addr.addEventListener('input', ()=>{ refresh(addr.value||''); });
    addr.addEventListener('focus', ()=>{ refresh(addr.value||''); });
    addr.addEventListener('keydown', (e)=>{
      const items = [...document.querySelectorAll('#omnibox-suggestions li')];
      if (!items.length) return;
      if (e.key === 'ArrowDown'){ e.preventDefault(); select( Math.min(items.length-1, activeIndex+1) ); }
      else if (e.key === 'ArrowUp'){ e.preventDefault(); select( Math.max(0, activeIndex-1) ); }
      else if (e.key === 'Enter'){ if (activeIndex>=0){ e.preventDefault(); apply(activeIndex); } }
      else if (e.key === 'Tab'){ if (activeIndex>=0){ e.preventDefault(); apply(activeIndex); } }
      else if (e.key === 'Escape'){ document.getElementById('omnibox-suggestions').style.display='none'; }
    });
    addr.addEventListener('blur', ()=> setTimeout(()=>{ document.getElementById('omnibox-suggestions').style.display='none'; }, 120) );
  });
</script>
</head>

<body>
  <!-- Header -->
  <div class="chrome" role="navigation" aria-label="Browser controls">
    <div class="row tabs">
      <div class="tabs-wrap" id="tabs" role="tablist" aria-label="Tabs">
        <button id="tab-add" class="tab-add" title="New tab"></button>
      </div>
    </div>
    <div class="row">
      <div class="omnibox">
        <button id="reload"  class="btn icon" title="Reload">↻</button>
        <button id="inspect" class="btn icon" title="Inspect (toggle)">&lt;/&gt;</button>
        <button id="settings" class="btn icon" title="Settings">⚙️</button>
        <button id="chrome-toggle" class="btn icon" title="Collapse" aria-label="Collapse">–</button>
        <img id="site-favicon" alt="" src="" referrerpolicy="no-referrer" crossorigin="anonymous" />
        <div class="sugg-wrap">
          <form id="sj-form" class="bar" autocomplete="off" role="search">
            <input id="sj-search-engine" type="hidden" value="https://www.google.com/search?q=%s" />
            <input id="sj-address" type="text" placeholder="URL or search…" spellcheck="false" inputmode="url" />
          </form>
          <ul id="omnibox-suggestions" role="listbox" aria-label="Suggestions"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Expand FAB (when collapsed) -->
  <button id="chrome-fab" class="btn icon fab" title="Expand" aria-label="Expand">+</button>

  <!-- Home -->
  <main class="home" id="home">
    <div class="hero">
      <h1 class="title">PROJECT TRINITY</h1>
      <p class="subtitle">1.2</p>
      <div class="links">
        <a href="https://github.com/MercuryWorkshop" target="_blank" rel="noopener">Github</a><span>·</span>
        <a href="https://www.trinity.gt.tc" target="_blank" rel="noopener">TRINITY</a><span>·</span>
        <span>PT © 2025</span>
      </div>
    </div>
  </main>

  <!-- Scramjet surface -->
  <iframe id="sj-frame"></iframe>

  <!-- Hooks -->
  <p id="sj-error"></p>
  <pre id="sj-error-code"></pre>

  <!-- Settings: dark-only gradients (12) -->
  <div id="settings-pop" class="settings-pop" role="dialog" aria-modal="false" aria-labelledby="settings-title">
    <div class="settings-group">
      <h4 id="settings-title">Gradient</h4>
      <div class="settings-row">
        <div class="swatch" data-value="graphite" style="background:linear-gradient(180deg,#0a0a0a,#0d0d0d 55%,#121212)"></div>
        <div class="swatch" data-value="abyss"    style="background:linear-gradient(180deg,#0a0f1a,#0b1320 55%,#0c1726)"></div>
        <div class="swatch" data-value="violet"   style="background:linear-gradient(180deg,#120a1a,#1a0f2b 55%,#23143a)"></div>
        <div class="swatch" data-value="teal"     style="background:linear-gradient(180deg,#071a1a,#0a2222 55%,#0d2a2a)"></div>
        <div class="swatch" data-value="slate"    style="background:linear-gradient(180deg,#0c0d10,#101218 55%,#141820)"></div>
        <div class="swatch" data-value="obsidian" style="background:linear-gradient(180deg,#0b0c0e,#101318 55%,#171b22)"></div>
        <div class="swatch" data-value="onyx"     style="background:linear-gradient(180deg,#0a0a0b,#0e0f11 55%,#141518)"></div>
        <div class="swatch" data-value="nebula"   style="background:linear-gradient(180deg,#0b0b14,#121430 55%,#1a1d47)"></div>
        <div class="swatch" data-value="cyber"    style="background:linear-gradient(180deg,#0a1014,#0b1620 55%,#0d1e2b)"></div>
        <div class="swatch" data-value="oil"      style="background:linear-gradient(180deg,#0a0a0a,#13100d 55%,#1b1612)"></div>
        <div class="swatch" data-value="night"    style="background:linear-gradient(180deg,#080a12,#0b0f1a 55%,#0f1524)"></div>
        <div class="swatch" data-value="carbon"   style="background:linear-gradient(180deg,#0a0a0b,#111213 55%,#191b1d)"></div>
      </div>
    </div>
  </div>
</body>
</html>
